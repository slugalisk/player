(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{1:function(e,t,n){"use strict";n.d(t,"d",function(){return s}),n.d(t,"g",function(){return r}),n.d(t,"h",function(){return u}),n.d(t,"b",function(){return o}),n.d(t,"e",function(){return c}),n.d(t,"c",function(){return h}),n.d(t,"a",function(){return l}),n.d(t,"f",function(){return d});var a=n(156),i=n.n(a),s=4294967295,r={Version:0,MinimumVersion:1,SwarmIdentifier:2,ContentIntegrityProtectionMethod:3,MerkleHashTreeFunction:4,LiveSignatureAlgorithm:5,ChunkAddressingMethod:6,LiveDiscardWindow:7,SupportedMessages:8,ChunkSize:9,EndOption:255},u={RFC7574:1},o={None:0,MerkleHashTree:1,SignAll:2,UnifiedMerkleTree:3},c={SHA1:0,SHA224:1,SHA256:2,SHA384:3,SHA512:4},h={RSASHA1:5,RSASHA256:8,ECDSAP256SHA256:13,ECDSAP384SHA384:14},l={Bin32:0,ByteRange64:1,ChunkRange32:2,Bin64:3,ChunkRange64:4},d={HANDSHAKE:0,DATA:1,ACK:2,HAVE:3,INTEGRITY:4,PEX_RESv4:5,PEX_REQ:6,SIGNED_INTEGRITY:7,REQUEST:8,CANCEL:9,CHOKE:10,UNCHOKE:11,PEX_RESv6:12,PEX_REScert:13};[r,u,o,c,h,l,d].forEach(function(e){var t=i()(e);e.name=function(e){return t[e]||"UNDEFINED"}})},100:function(e,t,n){},105:function(e,t,n){"use strict";var a=n(66),i=n.n(a);t.a=function(){var e=new Uint8Array(16);return i.a.randomFillSync(e),e}},158:function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return b});var a=n(8),i=n(5),s=n(7),r=n(6),u=n(2),o=n(4),c=n(19),h=n(66),l=n.n(h),d=n(42),f=n(74),v=n(1),p=n(55),b=function(){function t(n,a,i){Object(u.a)(this,t),this.swarm=n,this.chunkSize=a,this.chunksPerSignature=i,this.inputBuffer=e.alloc(0),this.chunkBuffer=[]}return Object(o.a)(t,[{key:"appendData",value:function(t){var n=this;if(this.inputBuffer.length+t.length<this.chunkSize)this.inputBuffer=e.concat([this.inputBuffer,t]);else{var a=0;this.inputBuffer.length>0&&(a=this.chunkSize-this.inputBuffer.length,this.chunkBuffer.push(e.concat([this.inputBuffer,t.slice(0,a)],this.chunkSize)));for(var i=a;i+this.chunkSize<t.length;i+=this.chunkSize)this.chunkBuffer.push(t.slice(i,Math.min(t.length,i+this.chunkSize))),a=i+this.chunkSize;a<t.length&&(this.inputBuffer=t.slice(a));for(var s=function(){var e=n.chunkBuffer.splice(0,n.chunksPerSignature);n.swarm.contentIntegrity.appendSubtree(e).then(function(t){n.swarm.chunkBuffer.setRange(t.rootAddress,e),n.swarm.scheduler.markChunksLoaded(t.rootAddress)})};this.chunkBuffer.length>this.chunksPerSignature;)s()}}}],[{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.chunkSize,a=void 0===n?8192:n,i=e.chunksPerSignature,s=void 0===i?64:i,u=e.liveDiscardWindow,o=void 0===u?Math.ceil(5376e4/a):u,c=e.chunkAddressingMethod,h=void 0===c?v.a.Bin32:c,l=e.contentIntegrityProtectionMethod,b=void 0===l?v.b.UnifiedMerkleTree:l,g=e.merkleHashTreeFunction,m=void 0===g?v.e.SHA256:g,k=e.liveSignatureAlgorithm,y=void 0===k?v.c.ECDSAP256SHA256:k;return Object(d.f)(y).then(function(e){var t,n=e.swarmId,i=e.privateKey,s=new f.a(n,(t={},Object(r.a)(t,v.g.ContentIntegrityProtectionMethod,b),Object(r.a)(t,v.g.MerkleHashTreeFunction,m),Object(r.a)(t,v.g.LiveSignatureAlgorithm,y),Object(r.a)(t,v.g.ChunkAddressingMethod,h),Object(r.a)(t,v.g.ChunkSize,a),t));console.log("swarm uri:",s.toString());var u={liveDiscardWindow:o,privateKey:i,uploadRateLimit:1e7};return new p.b(s,u)}).then(function(e){return new t(e,a,s)})}}]),t}();c.EventEmitter}).call(this,n(9).Buffer)},170:function(e,t,n){e.exports=n(339)},199:function(e,t){},20:function(e,t,n){"use strict";n.d(t,"a",function(){return u});var a=n(14),i=n(2),s=n(4),r=n(1),u=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.binBounds(t);Object(i.a)(this,e),this.bin=t;var s=Object(a.a)(n,2);this.start=s[0],this.end=s[1]}return Object(s.a)(e,[{key:"containsBin",value:function(e){return this.start<=e&&e<=this.end}},{key:"getChunkCount",value:function(){return(this.end-this.start)/2+1}}],[{key:"from",value:function(t){if(t instanceof e)return t;switch(t.type){case r.a.Bin32:return new e(t.value);case r.a.ChunkRange32:var n=t.start,a=t.end;return new e((a-n)/2,[n,a]);default:throw new Error("unsupported address type")}}},{key:"binBounds",value:function(e){return[e&e+1,(e|e+1)-1]}}]),e}()},201:function(e,t){},235:function(e,t){},236:function(e,t){},282:function(e,t,n){"use strict";n.r(t),function(e){var t=n(159),a=n.n(t);e.exports=new a.a}.call(this,n(283)(e))},295:function(e,t){e.exports=window.crypto},296:function(e,t,n){},297:function(e,t,n){},338:function(e,t,n){},339:function(e,t,n){"use strict";n.r(t);var a=n(3),i=n.n(a),s=n(155),r=n.n(s),u=n(341),o=n(342),c=n(343),h=n(14),l=n(74),d=n(2),f=n(4),v=n(8),p=n(5),b=n(7),g=n(157),m=n.n(g),k=n(67),y=n(103),O=n.n(y),w=n(76),j=(n(296),function(e){function t(){return Object(d.a)(this,t),Object(v.a)(this,Object(p.a)(t).apply(this,arguments))}return Object(b.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e=O()({diagnostic_menu__toggle_button:!0,"diagnostic_menu__toggle_button--expanded":this.props.expanded});return i.a.createElement("button",{onClick:this.props.onClick,className:e})}}]),t}(a.Component));j.defaultProps={expanded:!1};var C=function(e){function t(){return Object(d.a)(this,t),Object(v.a)(this,Object(p.a)(t).apply(this,arguments))}return Object(b.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e=this.props.value.scheduler,t=[{key:"totalSends",value:e.totalSends},{key:"totalRequests",value:e.totalRequests},{key:"totalRequestsReceived",value:e.totalRequestsReceived},{key:"totalDroppedRequests",value:e.totalDroppedRequests},{key:"totalReceived",value:e.totalReceived},{key:"totalAdded",value:e.totalAdded},{key:"totalCancelled",value:e.totalCancelled},{key:"ackUnknownSend",value:e.ackUnknownSend},{key:"lastCompletedBin",value:e.lastCompletedBin},{key:"picker.firstLoadedChunk",value:e.loadedChunks.min()},{key:"picker.firstRequestedChunk",value:e.requestedChunks.min()},{key:"chunkRate",value:e.chunkRate.value()}].map(function(e){var t=e.key,n=e.value;return i.a.createElement("tr",{key:t},i.a.createElement("td",{className:"diagnostic_table__key_cell"},t),i.a.createElement("td",null,n))});return i.a.createElement("div",{className:"swarm_state__container"},i.a.createElement("table",null,i.a.createElement("tbody",null,t)))}}]),t}(a.Component),S=function(e){function t(){return Object(d.a)(this,t),Object(v.a)(this,Object(p.a)(t).apply(this,arguments))}return Object(b.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e=this.props.value,t=[{key:"chunkIntervalMean",value:e.chunkIntervalMean.value()},{key:"wasteRate",value:e.wasteRate.value()},{key:"chunkRate",value:e.chunkRate.value()},{key:"ledbat.baseDelay",value:e.ledbat.baseDelay.getMin()},{key:"ledbat.currentDelay",value:e.ledbat.currentDelay.getMin()},{key:"ledbat.rttMean",value:e.ledbat.rttMean.value()},{key:"ledbat.rttVar",value:e.ledbat.rttVar.value()},{key:"ledbat.cwnd",value:e.ledbat.cwnd},{key:"ledbat.cto",value:e.ledbat.cto},{key:"ledbat.flightSize",value:e.ledbat.flightSize},{key:"validChunks",value:e.validChunks},{key:"requestQueue.length",value:e.requestQueue.length},{key:"requestedChunks.length",value:e.requestedChunks.length}].map(function(e){var t=e.key,n=e.value;return i.a.createElement("tr",{key:t},i.a.createElement("td",{className:"diagnostic_table__key_cell"},t),i.a.createElement("td",null,String(n)))}),n=this.props,a=n.startBin,s=n.endBin;return t.push(i.a.createElement("tr",{key:"availableChunks"},i.a.createElement("td",{colSpan:"2"},"Available",i.a.createElement(E,{value:this.props.value.availableChunks,startBin:a,endBin:s})))),t.push(i.a.createElement("tr",{key:"sentChunks"},i.a.createElement("td",{colSpan:"2"},"Sent",i.a.createElement(E,{value:this.props.value.sentChunks,startBin:a,endBin:s})))),t.push(i.a.createElement("tr",{key:"receivedChunks"},i.a.createElement("td",{colSpan:"2"},"Received",i.a.createElement(E,{value:this.props.value.receivedChunks,startBin:a,endBin:s})))),i.a.createElement("table",null,i.a.createElement("tbody",null,t))}}]),t}(a.Component),E=function(e){function t(e){var n;return Object(d.a)(this,t),(n=Object(v.a)(this,Object(p.a)(t).call(this,e))).canvas=i.a.createRef(),n}return Object(b.a)(t,e),Object(f.a)(t,[{key:"componentDidUpdate",value:function(){if(this.canvas.current){var e=this.props.value,t=isNaN(this.props.startBin)?e.min():this.props.startBin,n=isNaN(this.props.endBin)?e.max():this.props.endBin;if(isFinite(t)&&isFinite(n)&&!isNaN(t)&&!isNaN(n)){var a=this.canvas.current.getContext("2d"),i=Object(w.a)().domain([t,n]).range([0,500]);a.fillStyle="white",a.fillRect(0,0,500,20),a.fillStyle="#ccc";for(var s=-1,r=t;r<=n;r+=2)e.values.get((r+2)/2)&&r!==n?-1===s&&(s=r):-1!==s&&(a.fillRect(i(s),0,i(r)-i(s),20),s=-1)}}}},{key:"render",value:function(){return i.a.createElement("canvas",{height:"20",width:"500",ref:this.canvas})}}]),t}(a.Component),I=function(e){function t(e){var n;return Object(d.a)(this,t),(n=Object(v.a)(this,Object(p.a)(t).call(this,e))).handleButtonClick=function(){n.setState({expanded:!n.state.expanded})},n.state={expanded:!1},n}return Object(b.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e;return this.state.expanded&&(e=i.a.createElement(S,{value:this.props.value,startBin:this.props.startBin,endBin:this.props.endBin})),i.a.createElement("div",{className:"peer_state__container"},i.a.createElement("div",{className:"peer_state__header"},i.a.createElement(j,{onClick:this.handleButtonClick,expanded:this.state.expanded}),i.a.createElement("h4",{className:"peer_state__title"},this.props.value.peer.localId," : ",this.props.value.peer.remoteId)),e)}}]),t}(a.Component),A=function(e){function t(e){var n;return Object(d.a)(this,t),(n=Object(v.a)(this,Object(p.a)(t).call(this,e))).handleButtonClick=function(){n.setState({expanded:!n.state.expanded}),n.scheduleUpdate()},n.handleUpdate=function(){n.state.expanded&&n.forceUpdate(n.scheduleUpdate)},n.scheduleUpdate=function(){window.requestAnimationFrame(n.handleUpdate)},n.state={expanded:!1},n}return Object(b.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e,t,n=O()(this.props.containerClass,{diagnostic_menu__container:!0,"diagnostic_menu__container--expanded":this.state.expanded}),a=this.props.swarm.scheduler,s=a.lastCompletedBin,r=a.liveDiscardWindow,u=s-r,o=s+r;return this.state.expanded&&(e=i.a.createElement(C,{value:this.props.swarm,startBin:u,endBin:o}),t=Object.entries(this.props.swarm.scheduler.peerStates).map(function(e){var t=Object(h.a)(e,2),n=t[0],a=t[1];return i.a.createElement(I,{key:n,value:a,startBin:u,endBin:o})})),i.a.createElement("div",{className:n},i.a.createElement(j,{onClick:this.handleButtonClick,expanded:this.state.expanded}),e,t)}}]),t}(a.Component),B=n(9),M=(n(297),function(e){return console.log(e)}),R=function(e){function t(e){var n;return Object(d.a)(this,t),(n=Object(v.a)(this,Object(p.a)(t).call(this,e))).handleSourceOpen=function(e){var t=e.addSourceBuffer('video/mp4; codecs="mp4a.40.5,avc1.64001F"');t.addEventListener("updatestart",M),t.addEventListener("updateend",M),t.addEventListener("error",M);var a=[],i=!1;t.addEventListener("updateend",function(){a.length&&t.appendBuffer(a.shift())});var s=new m.a.mp4.Transmuxer;s.on("data",function(e){if("combined"===e.type){var n=i?e.data:B.Buffer.concat([B.Buffer.from(e.initSegment),B.Buffer.from(e.data)]);i=!0,t.updating?a.push(new Uint8Array(n)):t.appendBuffer(new Uint8Array(n))}else console.log("unhandled event",e.type)});var r=new k.a(n.props.swarm);r.on("start",function(e){return s.push(new Uint8Array(e))}),r.on("data",function(e){return s.push(new Uint8Array(e))}),r.on("end",function(e){s.push(new Uint8Array(e)),s.flush()})},n.video=i.a.createRef(),n}return Object(b.a)(t,e),Object(f.a)(t,[{key:"componentDidMount",value:function(){var e=this,t=new MediaSource;this.video.current.addEventListener("error",M),this.video.current.src=URL.createObjectURL(t),t.addEventListener("sourceopen",function(){return e.handleSourceOpen(t)})}},{key:"render",value:function(){return i.a.createElement(i.a.Fragment,null,i.a.createElement(A,{swarm:this.props.swarm}),i.a.createElement("video",{controls:!0,className:"swarm-player-video",ref:this.video}))}}]),t}(a.Component),D=n(55),x=n(56),L=n(36),H=function(){function e(t,n,a,i,s){Object(d.a)(this,e),this.connManager=t,this.swarmUri=s;var r=t.createClient(i);this.dhtClient=new x.a(n),this.dhtClient.on("peers.discover",this.handlePeersDiscover.bind(this)),this.dhtClient.on("receive.connect.request",this.handleReceiveConnectRequest.bind(this)),this.dhtClient.createChannel(a,r.createDataChannel("dht")),this.ppsppClient=new D.a,this.ppsppClient.createChannel(r.createDataChannel("ppspp")),r.init()}return Object(f.a)(e,[{key:"handlePeersDiscover",value:function(e){var t=new x.b(this.dhtClient,e),n=this.connManager.createClient(t);this.dhtClient.createChannel(e,n.createDataChannel("dht")),this.ppsppClient.createChannel(n.createDataChannel("ppspp"));var a=setTimeout(function(){return n.close()},1e4);this.dhtClient.send(e,"connect.request",{channelId:t.id},function(){clearTimeout(a),n.init()})}},{key:"handleReceiveConnectRequest",value:function(e){var t=this,n=e.data,a=n.channelId,i=n.from,s=e.callback,r=new L.a(i);this.connManager.createClient(new x.b(this.dhtClient,r,a)).on("datachannel",function(e){var n=e.channel;"dht"===n.label?t.dhtClient.createChannel(r,n):"ppspp"===n.label&&t.ppsppClient.createChannel(n)}),s({})}}],[{key:"create",value:function(t){return t.bootstrap().then(function(n){var a=n.data,i=n.conn;return new e(t,Object(L.a)(a.id),Object(L.a)(a.bootstrapId),i,a.swarmUri)})}}]),e}(),P=n(22),q=n(17),N=n(19),T=n(79),U=function(){function e(t){Object(d.a)(this,e),this.bootstrapAddress=t}return Object(f.a)(e,[{key:"bootstrap",value:function(){var e=this;return new Promise(function(t,n){var a=new WebSocket(e.bootstrapAddress);a.onmessage=function(e){var i=JSON.parse(e.data);"bootstrap"===i.type?t({data:i,conn:a}):n(new Error("expected bootstrap, received: ".concat(e.data)))}})}},{key:"createClient",value:function(e){var t=new _(e),n=new z(t);return t.once("error",function(){return e.close()}),n.once("open",function(){return e.close()}),n}}]),e}(),_=function(e){function t(e){var n;return Object(d.a)(this,t),(n=Object(v.a)(this,Object(p.a)(t).call(this))).conn=e,n.conn.onmessage=n.handleMessage.bind(Object(q.a)(n)),n}return Object(b.a)(t,e),Object(f.a)(t,[{key:"handleMessage",value:function(e){var t=JSON.parse(e.data);switch(t.type){case"offer":case"answer":this.emit("remotedescription",new T.RTCSessionDescription(t));break;case"icecandidate":t.sdp&&t.sdp.candidate&&this.emit("icecandidate",new T.RTCIceCandidate(t.sdp));break;default:this.emit("error",new Error("unsupported mediator event type"))}}},{key:"sendOffer",value:function(e){this.send(e)}},{key:"sendAnswer",value:function(e){this.send(e)}},{key:"sendIceCandidate",value:function(e){e.candidate&&this.send({type:"icecandidate",sdp:e.candidate})}},{key:"send",value:function(e){1===this.conn.readyState?this.conn.send(JSON.stringify(e)):this.emit("error",new Error("connection in invalid state"))}}]),t}(N.EventEmitter),z=function(e){function t(e){var n;return Object(d.a)(this,t),(n=Object(v.a)(this,Object(p.a)(t).call(this))).mediator=e,n.initialized=!1,n.waitingChannels=0,n.peerConn=new T.RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),n.peerConn.addEventListener("icecandidate",function(e){return n.mediator.sendIceCandidate(e)}),n.peerConn.addEventListener("datachannel",n.handleDataChannel.bind(Object(q.a)(n))),e.once("error",function(){return n.peerConn.close()}),e.on("icecandidate",function(e){return n.addIceCandidate(e)}),n._ready=new Promise(function(t,a){e.on("remotedescription",function(e){n.peerConn.setRemoteDescription(e).then(function(){t(),n.createAnswer()}).catch(a)})}),n}return Object(b.a)(t,e),Object(f.a)(t,[{key:"createAnswer",value:function(){var e=this;this.initialized||(this.initialized=!0,this.peerConn.createAnswer().then(function(t){e.peerConn.setLocalDescription(t),e.mediator.sendAnswer(t)}).catch(function(e){return console.error(e)}))}},{key:"addIceCandidate",value:function(e){var t=this;this._ready.then(function(){return t.peerConn.addIceCandidate(e)})}},{key:"handleDataChannel",value:function(e){this.waitingChannels++,e.channel.addEventListener("open",this.resolveWaitingChannel.bind(this),{once:!0}),this.emit("datachannel",e)}},{key:"createDataChannel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=Object(P.a)({ordered:!0,maxRetransmits:10},t);var n=this.peerConn.createDataChannel(e,t);return n.binaryType="arraybuffer",this.waitingChannels++,n.addEventListener("open",this.resolveWaitingChannel.bind(this),{once:!0}),n}},{key:"resolveWaitingChannel",value:function(){0===--this.waitingChannels&&(console.log("wrtc client opened"),this.emit("open"))}},{key:"init",value:function(){var e=this;this.peerConn.createOffer().then(function(t){e.initialized=!0,e.peerConn.setLocalDescription(t),e.mediator.sendOffer(t)})}},{key:"close",value:function(){console.log("wrtc client closed"),this.peerConn.close(),this.emit("close")}}]),t}(N.EventEmitter),V=(n(100),function(){var e=Object(a.useState)(null),t=Object(h.a)(e,2),n=t[0],s=t[1],r=Object(a.useState)(""),u=Object(h.a)(r,2),o=u[0],c=u[1],d=Object(a.useState)(null),f=Object(h.a)(d,2),v=f[0],p=f[1];if(Object(a.useEffect)(function(){var e="https:"===window.location.protocol?"wss":"ws",t=window.location.host,n="".concat(e,"://").concat(t);console.log({bootstrapAddress:n});var a=new U(n);H.create(a).then(function(e){var t=e.ppsppClient,n=e.swarmUri;s(t),c(n)})},[]),v)return i.a.createElement(R,{swarm:v});return i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"idle"},i.a.createElement("div",{className:"scanner"}),i.a.createElement("div",{className:"noise"})),i.a.createElement("form",{className:"join-form",onSubmit:function(e){e.preventDefault(),console.log(o);var t=l.a.parse(o);console.log("joining",t);var a=n.joinSwarm(t);p(a)}},i.a.createElement("input",{onChange:function(e){c(e.target.value)},placeholder:"Enter Swarm URI",defaultValue:o}),i.a.createElement("button",null,"Join")))}),K=n(25),W=n(57),F=function(){var e=Object(a.useState)(new W.b),t=Object(h.a)(e,1)[0],n=Object(a.useState)([]),s=Object(h.a)(n,2),r=s[0],u=s[1],o=Object(a.useState)(""),c=Object(h.a)(o,2),l=c[0],d=c[1];Object(a.useEffect)(function(){var e=new k.c;return e.on("publish",function(e){var n=e.swarm;d(n.uri),t.ppsppClient.publishSwarm(n)}),e.on("unpublish",function(e){var n=e.swarm;t.ppsppClient.unpublishSwarm(n)}),e.start(),function(){return e.stop()}},[]);var f=r.map(function(e,t){return i.a.createElement(A,{key:t,swarm:e,containerClass:"diagnostic-menu--indent-".concat(t)})});return i.a.createElement("div",null,f,i.a.createElement("button",{onClick:function(){H.create(new W.a(t)).then(function(e){var t=e.ppsppClient.joinSwarm(l);u([].concat(Object(K.a)(r),[t])),new k.b(t).on("data",function(e){return console.log("received ".concat(e.length," bytes"))})})}},"add peer"))},Q=n(169),G=n(15),Y=n.n(G),J=n(168),X=n(77),Z=Object(w.b)(X.a),$=function(e,t){var n=t.type,a=Object(Q.a)(t,["type"]);switch(n){case"ADD_NODE":return{nodes:[].concat(Object(K.a)(e.nodes),[a]),links:e.links};case"REMOVE_NODE":return{nodes:e.nodes.filter(function(e){return e.id!==a.id}),links:e.links.filter(function(e){var t=e.source,n=e.target;return t.id!==a.id&&n.id!==a.id})};case"ADD_LINK":return{nodes:e.nodes,links:[].concat(Object(K.a)(e.links),[Object(P.a)({},a,{activity:0})])};case"UPDATE_LINK":return{nodes:e.nodes,links:e.links.map(function(e){var t=e.source,n=e.target;return t.id!==a.source||n.id!==a.target?e:Object(P.a)({},e,a)})};case"INCR_LINK_ACTIVITY":return{nodes:e.nodes,links:e.links.map(function(e){var t=e.source,n=e.target;return t.id!==a.source||n.id!==a.target?e:Object(P.a)({},e,{activity:e.activity+1})})};case"DECR_LINK_ACTIVITY":return{nodes:e.nodes,links:e.links.map(function(e){var t=e.source,n=e.target;return t.id!==a.source||n.id!==a.target?e:Object(P.a)({},e,{activity:e.activity-1})})};case"REMOVE_LINK":return console.log(a),{nodes:e.nodes,links:e.links.filter(function(e){var t=e.source,n=e.target;return t.id!==a.source||n.id!==a.target})};default:return e}},ee=function(){var e=function(){var e=Object(a.useState)(new W.b),t=Object(h.a)(e,1)[0],n=Object(a.useState)(1),i=Object(h.a)(n,2),s=i[0],r=i[1],u=Object(a.useReducer)($,{nodes:[],links:[]}),o=Object(h.a)(u,2),c=o[0],l=o[1];return Object(a.useEffect)(function(){var e=Y()(t.dhtClient.id);l({type:"ADD_NODE",id:e,color:Z(0),dhtClient:t.dhtClient})},[]),[c,{addNodes:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(s+1),Promise.all(new Array(e).fill(0).map(function(){return H.create(new W.a(t))})).then(function(e){return e.forEach(function(e){var t=e.dhtClient,a=t.id,i=t.allChannels;console.log(i);var r=Y()(a);l(Object(P.a)({type:"ADD_NODE",id:r,color:Z(s),dhtClient:t},n)),t.on("close",function(){return l({type:"REMOVE_NODE",id:r})}),i.toArray().forEach(function(e){var t=e.id,n=e.conn;null!=n&&l({type:"ADD_LINK",source:r,target:Y()(t),color:n?"#fff":"#66f"})}),i.on("added",function(e){var t=e.id,n=e.conn;if(null!=n){var a=Y()(t);l({type:"ADD_LINK",source:r,target:a,color:n?"#fff":"#66f"})}}),i.on("updated",function(e,t){var n=e.conn,a=t.id,i=t.conn;if(i!==n){var s=Y()(a);l({type:"ADD_LINK",source:r,target:s,color:i?"#fff":"#66f"})}}),i.on("removed",function(e){var t=e.id;return l({type:"REMOVE_LINK",source:r,target:Y()(t)})})})})}}]}(),t=Object(h.a)(e,2),n=t[0],s=t[1].addNodes,r=function(){var e=Object(a.useState)(null),t=Object(h.a)(e,2),n=t[0],i=t[1];return function(e){if(console.log(e),null===n)return i(e),void console.log("set source",Y()(e.dhtClient.id));console.log("pinging %s > %s",Y()(n.dhtClient.id),Y()(e.dhtClient.id)),n.dhtClient.sendPing(e.dhtClient.id,function(e){console.log("received ping response",e)}),i(null)}}();return console.log(n),i.a.createElement("div",null,i.a.createElement("div",{className:"graph-buttons"},i.a.createElement("button",{onClick:function(){return s(1)}},"add 1 peer"),i.a.createElement("button",{onClick:function(){return s(5)}},"add 5 peers"),i.a.createElement("button",{onClick:function(){return s(10)}},"add 10 peers")),i.a.createElement(J.a,{graphData:n,nodeAutoColorBy:"gen",onNodeClick:r,linkColor:function(e){return e.color},linkWidth:1.5,nodeRelSize:2,nodeVal:function(e){return e.dhtClient.allChannels.count()}}))},te=function(){return i.a.createElement(u.a,null,i.a.createElement(o.a,null,i.a.createElement(c.a,{exact:!0,path:"/",component:V}),i.a.createElement(c.a,{exact:!0,path:"/test",component:F}),i.a.createElement(c.a,{exact:!0,path:"/dht-graph",component:ee})))};n(338);r.a.render(i.a.createElement(te,null),document.getElementById("root"))},36:function(e,t,n){"use strict";n.d(t,"a",function(){return s});var a=n(160),i=n.n(a);function s(e){return new Uint8Array(i()(e))}},42:function(e,t,n){"use strict";var a=n(8),i=n(5),s=n(31),r=n(7),u=n(25),o=n(2),c=n(4),h=n(14),l=n(22),d=n(6),f=n(9),v=n(50),p=n.n(v);var b,g,m,k=n(20),y=n(53),O=n(1);n.d(t,"a",function(){return S}),n.d(t,"e",function(){return E}),n.d(t,"c",function(){return A}),n.d(t,"d",function(){return B}),n.d(t,"f",function(){return M}),n.d(t,"b",function(){return D});var w="undefined"===typeof window?n(282):n(295),j=function(e){return new Uint8Array(e)},C=(b={},Object(d.a)(b,O.e.SHA1,"SHA-1"),Object(d.a)(b,O.e.SHA224,"SHA-224"),Object(d.a)(b,O.e.SHA256,"SHA-256"),Object(d.a)(b,O.e.SHA384,"SHA-384"),Object(d.a)(b,O.e.SHA512,"SHA-512"),b),S=(g={},Object(d.a)(g,O.e.SHA1,20),Object(d.a)(g,O.e.SHA224,28),Object(d.a)(g,O.e.SHA256,32),Object(d.a)(g,O.e.SHA384,48),Object(d.a)(g,O.e.SHA512,64),g),E=function(e){var t=C[e];if(void 0===t)throw new Error("invalid merkle hash tree function");var n=new Uint8Array(S[e]);return function(){for(var e=arguments.length,a=new Array(e),i=0;i<e;i++)a[i]=arguments[i];return(a=a.map(function(e){return void 0===e?n:e})).every(function(e){return p()(e,n)})?Promise.resolve(n):(a=a.length>1?new Uint8Array(f.Buffer.concat(a.map(function(e){return f.Buffer.from(e)}))):a[0],w.subtle.digest(t,a).then(j))}},I=(m={},Object(d.a)(m,O.c.RSASHA1,{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-1"}}),Object(d.a)(m,O.c.RSASHA256,{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}}),Object(d.a)(m,O.c.ECDSAP256SHA256,{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}}),Object(d.a)(m,O.c.ECDSAP384SHA384,{name:"ECDSA",namedCurve:"P-384",hash:{name:"SHA-384"}}),m),A=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n=Object(l.a)({},I[e],n);var a=w.subtle.importKey("pkcs8",t,n,!1,["sign"]);return function(e){return a.then(function(t){return w.subtle.sign(n,t,e)}).then(j)}},B=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n=Object(l.a)({},I[e],t.getKeyParams(),n);var a=new Uint8Array(t.publicKey),i=w.subtle.importKey("spki",a,n,!1,["verify"]);return function(e,t){return i.then(function(a){return w.subtle.verify(n,a,e,t)}).then(j)}},M=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t=Object(l.a)({},I[e],t),w.subtle.generateKey(t,!0,["sign","verify"]).then(function(e){return Promise.all([w.subtle.exportKey("pkcs8",e.privateKey),w.subtle.exportKey("spki",e.publicKey)])}).then(function(n){var a=Object(h.a)(n,2),i=a[0],s=a[1];return{privateKey:i,publicKey:s,swarmId:y.a.from(Object(l.a)({},t,{liveSignatureAlgorithm:e,publicKey:s}))}})},R=function(){return Promise.reject("live signature function not available")},D=function(e,t,n){var h=arguments.length>3&&void 0!==arguments[3]?arguments[3]:R,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0,d=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(o.a)(this,e),this.hash=t,this.verified=n}return Object(c.a)(e,[{key:"markVerified",value:function(){this.verified=!0}},{key:"getHash",value:function(){return this.hash}},{key:"compare",value:function(e){return this.verified?Promise.resolve(p()(this.hash,e)):Promise.reject("cannot use unverified signature")}}]),e}(),f=function(){function e(t,n){Object(o.a)(this,e),this.signature=t,this.hash=n,this.verificationResult=void 0}return Object(c.a)(e,[{key:"verifyHash",value:function(){var e=this;return void 0===this.verificationResult&&(this.verificationResult=n(this.hash,this.getHash()).then(function(){return e.markVerified()})),this.verificationResult}},{key:"markVerified",value:function(){this.signature.markVerified()}},{key:"getHash",value:function(){return this.signature.getHash()}},{key:"getSignatureHash",value:function(){return this.hash}},{key:"compare",value:function(e){var t=this;return this.verifyHash().then(function(){return t.signature.compare(e)})}}]),e}(),v=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Array(2*t.getChunkCount()-1);Object(o.a)(this,e),this.rootAddress=t,this.signatures=n}return Object(c.a)(e,[{key:"createVerifier",value:function(){return new b(this)}},{key:"copy",value:function(e){for(var t=0;t<this.signatures.length;t++)void 0===e.signatures[t]&&(e.signatures[t]=this.signatures[t])}},{key:"getChunkCount",value:function(){return this.rootAddress.getChunkCount()}},{key:"getConstituentHashBins",value:function(e){var t=e.bin;if(!this.rootAddress.containsBin(t))throw new Error("bin out of range");var n=this.rootAddress.start;t-=n;for(var a=[],i=this.rootAddress.getChunkCount()+t/2-1,s=2,r=t;0!==i;){var u=1===(1&i)?1:-1;a.push({isRoot:!1,branch:u,bin:r+n,bfsIndex:i,siblingBin:r+u*s+n,siblingBfsIndex:i+u}),i=Math.floor((i-1)/2),r+=u*s/2,s*=2}return a.push({isRoot:!0,branch:0,bin:r+n,bfsIndex:0,siblingBin:r+n,siblingBfsIndex:0}),a}},{key:"getConstituentSignatures",value:function(e){var t=this;return this.getConstituentHashBins(e).map(function(e){var n=e.siblingBin,a=e.siblingBfsIndex;return{bin:n,signature:t.signatures[a]}})}}],[{key:"from",value:function(n){for(var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new k.a(e.minSize(n.length)-1),i=a.getChunkCount(),s=new Array(2*i-1),r=0;r<i;r++)s[r+i-1]=t(n[r]);for(var o=2*(i-1);o>0;o-=2)s[Math.floor(o/2)-1]=Promise.all([s[o-1],s[o]]).then(function(e){return t.apply(void 0,Object(u.a)(e))});return Promise.all(s).then(function(t){var n=t.map(function(e){return new d(e,!0)});return h(t[0]).then(function(t){return n[0]=new f(n[0],t),new e(a,n)})})}},{key:"minSize",value:function(e){return Math.pow(2,Math.ceil(Math.log2(e)))}}]),e}(),b=function(){function e(t){Object(o.a)(this,e),this.hashTree=t,this.signatures={}}return Object(c.a)(e,[{key:"setHash",value:function(e,t){var n=e.bin;this.signatures[n]=new d(t)}},{key:"setHashSignature",value:function(e,t){var n=e.bin,a=new f(this.signatures[n],t);this.signatures[n]=a}},{key:"verifyChunk",value:function(e,n){var a=this,i=[],s=t(n);return this.hashTree.getConstituentHashBins(e).some(function(e){var n=e.isRoot,r=e.branch,u=e.bfsIndex,o=e.siblingBin,c=e.siblingBfsIndex,h=a.hashTree.signatures[c];void 0===h&&(h=a.signatures[o],i.push({index:c,signature:h}));var l=a.hashTree.signatures[u];return void 0!==l?(s=s.then(function(e){return l.compare(e)}),!0):n?(s=s.then(function(e){return h.compare(e)}),!0):(s=s.then(function(e){i.push({index:u,signature:new d(e)});var n=h.getHash(),a=1===r?[e,n]:[n,e];return t.apply(void 0,a)}),!1)}),s.then(function(){i.forEach(function(e){var t=e.index,n=e.signature;n.markVerified(),a.hashTree.signatures[t]=n})})}}]),e}(),g=function(){function e(){Object(o.a)(this,e),this.subtrees=[],this.nextStart=0,this.chunkCount=0}return Object(c.a)(e,[{key:"findSubtree",value:function(e){var t=this,n=e.bin,a=function(e,t){for(var n=0,a=e;n<=a;){var i=n+Math.floor((a-n)/2),s=t(i);if(s<0)n=i+1;else{if(!(s>0))return i;a=i-1}}return-(n+1)}(this.subtrees.length-1,function(e){var a=t.subtrees[e].rootAddress,i=a.start,s=a.end;return i<=n&&n<=s?0:i-n});return a<0?void 0:this.subtrees[a]}},{key:"insertSubtree",value:function(e){var t=this.findSubtree(e.rootAddress);return void 0!==t?(t!==e&&e.copy(t),t):(this.subtrees.push(e),this.subtrees.sort(function(e,t){return e.rootAddress.start-t.rootAddress.start}),this.chunkCount+=e.getChunkCount(),this.pruneSubtrees(),e)}},{key:"pruneSubtrees",value:function(){for(;this.subtrees.length>0&&this.chunkCount-this.subtrees[0].getChunkCount()>l;){var e=this.subtrees.shift();this.chunkCount-=e.getChunkCount()}}},{key:"appendSubtree",value:function(e){var t=this,n=v.minSize(e.length),a=new k.a(this.nextStart+n-1,[this.nextStart,this.nextStart+2*(n-1)]);return this.nextStart+=2*n,v.from(e,a).then(function(e){return t.insertSubtree(e)})}},{key:"createVerifier",value:function(e){var t=this.findSubtree(e)||new v(e);return new m(this,t)}},{key:"getConstituentSignatures",value:function(e){var t=this.findSubtree(e);if(void 0!==t)return t.getConstituentSignatures(e)}}]),e}(),m=function(e){function t(e,n){var s;return Object(o.a)(this,t),(s=Object(a.a)(this,Object(i.a)(t).call(this,n))).unifiedHashTree=e,s}return Object(r.a)(t,e),Object(c.a)(t,[{key:"verifyChunk",value:function(e,n){return Object(s.a)(Object(i.a)(t.prototype),"verifyChunk",this).call(this,e,n).then(this.unifiedHashTree.insertSubtree(this.hashTree))}}]),t}(b),y=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"setHash",value:function(){}},{key:"setHashSignature",value:function(){}},{key:"verifyChunk",value:function(){return Promise.resolve()}}]),e}(),w=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"createVerifier",value:function(){return new y}},{key:"getConstituentSignatures",value:function(){return[]}}]),e}();switch(e){case O.b.None:return new w;case O.b.MerkleHashTree:return new v;case O.b.UnifiedMerkleTree:return new g;default:throw new Error("unsupported content integrity protection method")}}},53:function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return u});var a=n(2),i=n(4),s=n(1),r=function(e){return[s.c.RSASHA1,s.c.RSASHA256].includes(e)},u=function(){function t(n,i,s,r){Object(a.a)(this,t),this.liveSignatureAlgorithm=n,this.publicKey=e.from(i),this.publicExponent=s,this.modulusLength=r}return Object(i.a)(t,[{key:"getLiveSignatureByteLength",value:function(){switch(this.liveSignatureAlgorithm){case s.c.RSASHA1:case s.c.RSASHA256:return this.modulusLength/8;case s.c.ECDSAP256SHA256:return 64;case s.c.ECDSAP384SHA384:return 96;default:throw new Error("unsupported live signature algorithm")}}},{key:"getKeyParams",value:function(){return r(this.liveSignatureAlgorithm)?{publicExponent:new Uint8Array(this.publicExponent),modulusLength:this.modulusLength}:{}}},{key:"byteLength",value:function(){var e=r(this.liveSignatureAlgorithm)?9:1;return this.publicKey.length+e}},{key:"toBuffer",value:function(){var t=e.alloc(this.byteLength()),n=0;return t.writeUInt8(this.liveSignatureAlgorithm,n),n+=1,r(this.liveSignatureAlgorithm)&&(e.from(this.publicExponent).copy(t,n+4-this.publicExponent.length),n+=4,t.writeUInt32BE(this.modulusLength,n),n+=4),this.publicKey.copy(t,n),t}},{key:"read",value:function(e){var t=0;this.liveSignatureAlgorithm=e.readUInt8(0),t+=1,r(this.liveSignatureAlgorithm)&&(this.publicExponent=e.slice(t,t+4),t+=4,this.modulusLength=e.readUInt32BE(t),t+=4),this.publicKey=e.slice(t)}}],[{key:"from",value:function(n){if(ArrayBuffer.isView(n)){var a=Object.create(t.prototype);return a.read(e.from(n)),a}return new t(n.liveSignatureAlgorithm,n.publicKey,n.publicExponent,n.modulusLength)}}]),t}()}).call(this,n(9).Buffer)},55:function(e,t,n){"use strict";var a=n(17),i=n(25),s=n(22),r=n(6),u=n(14),o=n(2),c=n(4),h=n(8),l=n(5),d=n(7),f=n(19),v=n(20),p=n(53),b=function(){function e(t){Object(o.a)(this,e),this.mean=0,this.alpha=t,this.weight=1}return Object(c.a)(e,[{key:"update",value:function(e){this.mean=this.alpha*e+(1-this.alpha)*this.mean,this.weight*=this.alpha}},{key:"set",value:function(e){this.mean=e,this.weight=0}},{key:"isEmpty",value:function(){return 1===this.weight}},{key:"value",value:function(){return this.mean/(1-this.weight)}}]),e}(),g=function(){function e(t){Object(o.a)(this,e),this.setCapacity(t)}return Object(c.a)(e,[{key:"setCapacity",value:function(e){this.capacity=e,this.lastIndex=e,this.values=new Array(e);for(var t=0;t<e;t++)this.values[t]=this.createEmptyValue(t)}},{key:"advanceLastIndex",value:function(e){if(!(this.lastIndex>e)){var t=this.lastIndex;e-t>this.capacity&&(t=e-this.capacity);for(var n=t;n<=e;n++){var a=n%this.capacity;this.values[a]=this.createEmptyValue(n,this.values[a])}this.lastIndex=e+1}}},{key:"createEmptyValue",value:function(){}},{key:"set",value:function(e,t){this.advanceLastIndex(e),this.values[e%this.capacity]=t}},{key:"get",value:function(e){if(!(e<this.lastIndex-this.capacity||e>=this.lastIndex))return this.values[e%this.capacity]}},{key:"push",value:function(e){this.set(this.lastIndex,e)}}]),e}(),m=function(e){function t(e,n){var a;return Object(o.a)(this,t),(a=Object(h.a)(this,Object(l.a)(t).call(this,e))).min=1/0,a.window=n,a}return Object(d.a)(t,e),Object(c.a)(t,[{key:"createEmptyValue",value:function(){return 1/0}},{key:"getMin",value:function(){return this.min}},{key:"update",value:function(e){var t=Math.floor(Date.now()/this.window);t>=this.lastIndex&&(this.advanceLastIndex(t),this.min=Math.min.apply(Math,Object(i.a)(this.values))),e<this.get(t)&&(this.set(t,e),this.min=Math.min(this.min,e))}}]),t}(g),k=100,y=4,O=1e3,w=10,j=6e4,C=2,S=8192,E=.125,I=.25,A=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:k,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:S;Object(o.a)(this,e),this.target=t,this.mss=n,this.flightSize=0,this.cwnd=C*S,this.cto=1e3,this.currentDelay=new m(y,O),this.baseDelay=new m(w,j),this.lastDataLoss=0,this.lastAckTime=1/0,this.rttMean=new b(E),this.rttVar=new b(I),this.ackSize=0}return Object(c.a)(e,[{key:"addSent",value:function(e){this.flightSize+=e}},{key:"addDelaySample",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:S;this.currentDelay.update(e),this.baseDelay.update(e),this.ackSize+=t,this.lastAckTime=Date.now()}},{key:"digestDelaySamples",value:function(){if(this.checkCTO(),0!==this.ackSize){var e=Math.abs(this.currentDelay.getMin()-this.baseDelay.getMin()),t=(this.target-e)/this.target;this.cwnd+=1*t*this.ackSize*this.mss/this.cwnd;var n=this.flightSize+1*this.mss;this.cwnd=Math.max(Math.min(this.cwnd,n),2*this.mss),this.flightSize=Math.max(0,this.flightSize-this.ackSize),this.ackSize=0}}},{key:"checkCTO",value:function(){this.flightSize>0&&Date.now()-this.cto>this.lastAckTime&&(this.cwnd=this.mss,this.cto=2*this.cto)}},{key:"addRttSample",value:function(e){this.rttMean.isEmpty()?(this.rttMean.set(e),this.rttVar.set(e/2)):(this.rttVar.update(Math.abs(this.rttMean.value()-e)),this.rttMean.update(e)),this.cto=this.rttMean.value()+Math.max(1,4*this.rttVar.value()),this.cto<1e3&&(this.cto=1e3)}},{key:"onDataLoss",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=Date.now();0!==this.lastDataLoss&&n-this.lastDataLoss<this.rttMean.value()||(this.lastDataLoss=n,this.cwnd=Math.min(this.cwnd,Math.max(this.cwnd/2,2*this.mss)),t||(this.flightSize=Math.max(0,this.flightSize-e)))}}],[{key:"computeOneWayDelay",value:function(e){return Date.now()-e}}]),e}(),B=n(9),M=n(42),R=n(1),D=function(e,t){var n=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(o.a)(this,e),this.type=R.a.Bin32,this.value=t}return Object(c.a)(e,[{key:"read",value:function(e,t){return this.value=e.readUInt32BE(t),4}},{key:"byteLength",value:function(){return 4}},{key:"write",value:function(e,t){e.writeUInt32BE(this.value,t)}},{key:"rangeByteLength",value:function(){var e=v.a.binBounds(this.value),n=Object(u.a)(e,2),a=n[0];return(n[1]-a+1)*t}}],[{key:"from",value:function(t){return new e(t.bin)}}]),e}(),a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;Object(o.a)(this,e),this.type=R.a.ChunkRange32,this.start=t,this.end=n}return Object(c.a)(e,[{key:"read",value:function(e,t){return this.start=e.readUInt32BE(t),this.end=e.readUInt32BE(t+4),8}},{key:"byteLength",value:function(){return 8}},{key:"write",value:function(e,t){e.writeUInt32BE(this.start,t),e.writeUInt32BE(this.end,t+4)}},{key:"rangeByteLength",value:function(){return(this.end-this.start+1)*t}}],[{key:"from",value:function(t){return new e(t.start,t.end)}}]),e}();switch(e){case R.a.Bin32:return n;case R.a.ChunkRange32:return a;default:throw new Error("unsupported chunk addressing method")}},x=function(e){return function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:B.Buffer.alloc(e);Object(o.a)(this,t),this.value=B.Buffer.from(n)}return Object(c.a)(t,[{key:"read",value:function(t,n){return t.copy(this.value,0,n,n+e),e}},{key:"byteLength",value:function(){return e}},{key:"write",value:function(e,t){this.value.copy(e,t)}}]),t}()},L=function(e,t){var n=t.getLiveSignatureByteLength();return function(t){function n(t){var a;return Object(o.a)(this,n),(a=Object(h.a)(this,Object(l.a)(n).call(this,t))).type=e,a}return Object(d.a)(n,t),n}(x(n))},H=function(e){var t=M.a[e];return function(t){function n(t){var a;return Object(o.a)(this,n),(a=Object(h.a)(this,Object(l.a)(n).call(this,t))).type=e,a}return Object(d.a)(n,t),n}(x(t))},P=function(e,t,n){var a,s,u=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(o.a)(this,e),this.value=t}return Object(c.a)(e,[{key:"read",value:function(e,t){return this.value=e.readUInt8(t),1}},{key:"byteLength",value:function(){return 1}},{key:"write",value:function(e,t){e.writeUInt8(this.value,t)}}]),e}(),f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(o.a)(this,e),this.value=t}return Object(c.a)(e,[{key:"read",value:function(e,t){return this.value=e.readUInt32BE(t),4}},{key:"byteLength",value:function(){return 4}},{key:"write",value:function(e,t){e.writeUInt32BE(this.value,t)}}]),e}(),v=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:R.h.RFC7574;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).type=R.g.Version,e}return Object(d.a)(t,e),t}(u),p=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:R.h.RFC7574;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).type=R.g.MinimumVersion,e}return Object(d.a)(t,e),t}(u),b=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];Object(o.a)(this,e),this.type=R.g.SwarmIdentifier,this.value=B.Buffer.from(t)}return Object(c.a)(e,[{key:"read",value:function(e,t){var n=e.readUInt16BE(t);return t+=2,this.value=e.slice(t,t+n),n+2}},{key:"byteLength",value:function(){return this.value.length+2}},{key:"write",value:function(e,t){e.writeUInt16BE(this.value.length,t),this.value.copy(e,t+2)}}]),e}(),g=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:R.b.MerkleHashTree;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).type=R.g.ContentIntegrityProtectionMethod,e}return Object(d.a)(t,e),t}(u),m=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:R.e.SHA256;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).type=R.g.MerkleHashTreeFunction,e}return Object(d.a)(t,e),t}(u),k=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:R.c.ECDSAP256SHA256;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).type=R.g.LiveSignatureAlgorithm,e}return Object(d.a)(t,e),t}(u),y=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:R.a.ChunkRange32;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).type=R.g.ChunkAddressingMethod,e}return Object(d.a)(t,e),t}(u),O=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).type=R.g.LiveDiscardWindow,e}return Object(d.a)(t,e),t}(f),w=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object.values(R.f).filter(function(e){return!isNaN(e)});Object(o.a)(this,e),this.type=R.g.SupportedMessages,this.value={},n.forEach(function(e){return t.value[e]=!0})}return Object(c.a)(e,[{key:"read",value:function(e,t){var n=e.readUInt8(t);t+=1;for(var a=0;a<n;a++)for(var i=e[t+a],s=0;s<8;s++)this.value[8*a+s]=Boolean(i&1<<7-s);return n+1}},{key:"bitmapByteLength",value:function(){return Math.ceil(Math.max.apply(Math,Object(i.a)(Object.keys(this.value)))/8)+1}},{key:"toBitmap",value:function(){for(var e=this.bitmapByteLength(),t=B.Buffer.alloc(e),n=0;n<e;n++){for(var a=0,i=0;i<8;i++)a=a<<1|(this.value[8*n+i]?1:0);t.writeUInt8(a,n)}return t}},{key:"byteLength",value:function(){return this.bitmapByteLength()+1}},{key:"write",value:function(e,t){var n=this.toBitmap();e.writeUInt8(n.length,t),n.copy(e,t+1)}}]),e}(),j=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).type=R.g.ChunkSize,e}return Object(d.a)(t,e),t}(f),C=(a={},Object(r.a)(a,R.g.Version,v),Object(r.a)(a,R.g.MinimumVersion,p),Object(r.a)(a,R.g.SwarmIdentifier,b),Object(r.a)(a,R.g.ContentIntegrityProtectionMethod,g),Object(r.a)(a,R.g.MerkleHashTreeFunction,m),Object(r.a)(a,R.g.LiveSignatureAlgorithm,k),Object(r.a)(a,R.g.ChunkAddressingMethod,y),Object(r.a)(a,R.g.LiveDiscardWindow,O),Object(r.a)(a,R.g.SupportedMessages,w),Object(r.a)(a,R.g.ChunkSize,j),a),S=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];Object(o.a)(this,e),this.type=R.f.HANDSHAKE,this.channelId=t,this.options=n}return Object(c.a)(e,[{key:"read",value:function(e,t){var n=0;for(this.channelId=e.readUInt32BE(t),n+=4;t+n<e.length;){var a=e.readUInt8(t+n);if(n+=1,a===R.g.EndOption)break;var i=new(0,C[a]);n+=i.read(e,t+n),this.options.push(i)}return n}},{key:"byteLength",value:function(){return this.options.reduce(function(e,t){return e+t.byteLength()+1},0)+5}},{key:"write",value:function(e,t){var n=0;return e.writeUInt32BE(this.channelId,t),n+=4,this.options.forEach(function(a){e.writeUInt8(a.type,t+n),n+=1,a.write(e,t+n),n+=a.byteLength()}),e.writeUInt8(R.g.EndOption,t+n),n+=1}}]),e}(),E=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now();Object(o.a)(this,e),this.value=t}return Object(c.a)(e,[{key:"read",value:function(e,t){var n=e.readInt32BE(t),a=e.readInt32BE(t+4);return this.value=1e3*n+a/1e6,8}},{key:"byteLength",value:function(){return 8}},{key:"write",value:function(e,t){e.writeInt32BE(Math.floor(this.value/1e3),t),e.writeInt32BE(this.value%1e3*1e6,t+4)}}]),e}(),I=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new E;Object(o.a)(this,t),this.type=R.f.DATA,this.address=n,this.data=B.Buffer.from(a),this.timestamp=i}return Object(c.a)(t,[{key:"read",value:function(e,t){var n=this.address.read(e,t);t+=n+=this.timestamp.read(e,t+n);var a=Math.min(this.address.rangeByteLength(),e.length-t);return this.data=e.slice(t,t+a),n+a}},{key:"byteLength",value:function(){return this.address.byteLength()+this.data.length+8}},{key:"write",value:function(e,t){var n=0;this.address.write(e,t),n+=this.address.byteLength(),this.timestamp.write(e,t+n),n+=this.timestamp.byteLength(),this.data.copy(e,t+n)}}]),t}(),A=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e;Object(o.a)(this,t),this.address=n}return Object(c.a)(t,[{key:"read",value:function(e,t){return this.address.read(e,t)}},{key:"byteLength",value:function(){return this.address.byteLength()}},{key:"write",value:function(e,t){this.address.write(e,t)}}]),t}(),M=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new E;Object(o.a)(this,t),this.type=R.f.ACK,this.address=n,this.delaySample=a}return Object(c.a)(t,[{key:"read",value:function(e,t){var n=this.address.read(e,t);return n+=this.delaySample.read(e,t+n)}},{key:"byteLength",value:function(){return this.address.byteLength()+this.delaySample.byteLength()}},{key:"write",value:function(e,t){this.address.write(e,t),this.delaySample.write(e,t+this.address.byteLength())}}]),t}(),D=function(e){function t(e){var n;return Object(o.a)(this,t),(n=Object(h.a)(this,Object(l.a)(t).call(this,e))).type=R.f.HAVE,n}return Object(d.a)(t,e),t}(A),x=function(){function n(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t;Object(o.a)(this,n),this.type=R.f.INTEGRITY,this.address=a,this.hash=i}return Object(c.a)(n,[{key:"read",value:function(e,t){var n=this.address.read(e,t);return n+=this.hash.read(e,t+n)}},{key:"byteLength",value:function(){return this.address.byteLength()+this.hash.byteLength()}},{key:"write",value:function(e,t){this.address.write(e,t),this.hash.write(e,t+this.address.byteLength())}}]),n}(),L=function(){function t(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new E,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new n;Object(o.a)(this,t),this.type=R.f.SIGNED_INTEGRITY,this.address=a,this.timestamp=i,this.signature=s}return Object(c.a)(t,[{key:"read",value:function(e,t){var n=this.address.read(e,t);return n+=this.timestamp.read(e,t+n),n+=this.signature.read(e,t+n)}},{key:"byteLength",value:function(){return this.address.byteLength()+this.timestamp.byteLength()+this.signature.byteLength()}},{key:"write",value:function(e,t){var n=0;this.address.write(e,t),n+=this.address.byteLength(),this.timestamp.write(e,t+n),n+=this.timestamp.byteLength(),this.signature.write(e,t+n)}}]),t}(),H=function(e){function t(e){var n;return Object(o.a)(this,t),(n=Object(h.a)(this,Object(l.a)(t).call(this,e))).type=R.f.REQUEST,n}return Object(d.a)(t,e),t}(A),P=function(e){function t(e){var n;return Object(o.a)(this,t),(n=Object(h.a)(this,Object(l.a)(t).call(this,e))).type=R.f.CANCEL,n}return Object(d.a)(t,e),t}(A),q=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"read",value:function(){return 0}},{key:"byteLength",value:function(){return 0}},{key:"write",value:function(){}}]),e}(),N=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this))).type=R.f.CHOKE,e}return Object(d.a)(t,e),t}(q),T=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this))).type=R.f.UNCHOKE,e}return Object(d.a)(t,e),t}(q),U=(s={},Object(r.a)(s,R.f.HANDSHAKE,S),Object(r.a)(s,R.f.DATA,I),Object(r.a)(s,R.f.ACK,M),Object(r.a)(s,R.f.HAVE,D),Object(r.a)(s,R.f.INTEGRITY,x),Object(r.a)(s,R.f.SIGNED_INTEGRITY,L),Object(r.a)(s,R.f.REQUEST,H),Object(r.a)(s,R.f.CANCEL,P),Object(r.a)(s,R.f.CHOKE,N),Object(r.a)(s,R.f.UNCHOKE,T),s),_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];Object(o.a)(this,e),this.values=t,this.buffer=null,this.offset=0}return Object(c.a)(e,[{key:"next",value:function(){if(!(this.offset>=this.buffer.length)){var e=this.buffer.readUInt8(this.offset);this.offset+=1;var t=new(0,U[e]);return this.values.push(t),this.offset+=t.read(this.buffer,this.offset),t}}},{key:"toArray",value:function(){for(;this.next(););return this.values}},{key:"read",value:function(e,t){return this.buffer=e,this.offset=t,0}},{key:"byteLength",value:function(){return this.values.reduce(function(e,t){return e+t.byteLength()+1},0)}},{key:"write",value:function(e,t){var n=0;return this.values.forEach(function(a){e.writeUInt8(a.type,t+n),n+=1,a.write(e,t+n),n+=a.byteLength()}),n}}],[{key:"from",value:function(t){if(t instanceof e)return t;if(Array.isArray(t))return new e(t);throw new Error("unable to create Messages from unsupported type")}}]),e}();return{VersionProtocolOption:v,MinimumVersionProtocolOption:p,SwarmIdentifierProtocolOption:b,ContentIntegrityProtectionMethodProtocolOption:g,MerkleHashTreeFunctionProtocolOption:m,LiveSignatureAlgorithmProtocolOption:k,ChunkAddressingMethodProtocolOption:y,LiveDiscardWindowProtocolOption:O,SupportedMessagesProtocolOption:w,ChunkSizeProtocolOption:j,HandshakeMessage:S,Timestamp:E,DataMessage:I,AckMessage:M,HaveMessage:D,IntegrityMessage:x,SignedIntegrityMessage:L,RequestMessage:H,CancelMessage:P,ChokeMessage:N,UnchokeMessage:T,Datagram:function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];Object(o.a)(this,e),this.channelId=t,this.messages=_.from(n)}return Object(c.a)(e,[{key:"read",value:function(e){var t=B.Buffer.from(e),n=0;return this.channelId=t.readUInt32BE(0),n+=4,n+=this.messages.read(t,n)}},{key:"byteLength",value:function(){return this.messages.byteLength()+4}},{key:"write",value:function(e){var t=0;return e.writeUInt32BE(this.channelId,0),t+=4,t+=this.messages.write(e,t)}},{key:"toBuffer",value:function(){var e=B.Buffer.alloc(this.byteLength());return this.write(e),e}}],[{key:"from",value:function(t){var n=new e;return n.read(t),n}}]),e}(),LiveSignature:n,IntegrityHash:t,ChunkAddress:e}},q=n(31);function N(e){for(var t=0,n=0;n<e;n++)t=t<<1|1;return t}function T(e,t,n){return n?e|t:e&(255^t)}var U=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(o.a)(this,e),this.offset=0,this.resize(t)}return Object(c.a)(e,[{key:"resize",value:function(e){this.capacity=e,this.values=new Uint8Array(Math.ceil(e/8))}},{key:"adjustOffset",value:function(e){var t=this.offset,n=e-t-this.capacity;n<=0||(this.offset+=n,this.unsafelySetRange(t+1,t+n+1,!1))}},{key:"getByteIndex",value:function(e){return Math.floor(e/8)%this.values.length}},{key:"getBitIndex",value:function(e){return e%8}},{key:"getIndexValue",value:function(e,t){var n=this.offset%(8*this.values.length);return(e<n?this.offset+8*this.values.length-n:this.offset)+(8*e+t)}},{key:"setRange",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];t-e!==1?t<=this.offset||(e=Math.max(e,this.offset),this.adjustOffset(t),this.unsafelySetRange(e,t,n)):this.set(e,n)}},{key:"unsafelySetRange",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(t-e>=this.capacity)this.values.fill(n?255:0);else{var a=this.getByteIndex(e),i=this.getByteIndex(t),s=this.getBitIndex(e),r=this.getBitIndex(t);if(a>i)return this.unsafelySetIndexRange(a,s,this.capacity,0,n),void this.unsafelySetIndexRange(0,0,i,r,n);this.unsafelySetIndexRange(a,s,i,r,n)}}},{key:"unsafelySetIndexRange",value:function(e,t,n,a,i){var s=N(8-t),r=255^N(8-a);if(e!==n)this.values[e]=T(this.values[e],s,i),this.values[n]=T(this.values[n],r,i),n-e>1&&this.values.fill(i?255:0,e+1,n);else{var u=s&r;this.values[e]=T(this.values[e],u,i)}}},{key:"unsetRange",value:function(e,t){this.setRange(e,t,!1)}},{key:"set",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!(e<this.offset)){this.adjustOffset(e);var n=this.getByteIndex(e),a=1<<7-this.getBitIndex(e);this.values[n]=T(this.values[n],a,t)}}},{key:"unset",value:function(e){this.set(e,!1)}},{key:"get",value:function(e){if(e<=this.offset||e>this.offset+this.capacity)return!1;var t=this.getByteIndex(e),n=1<<7-this.getBitIndex(e);return 0!==(this.values[t]&n)}},{key:"toValueArray",value:function(){for(var e=[],t=1;t<=this.capacity;t++)this.get(this.offset+t)&&e.push(this.offset+t);return e}},{key:"min",value:function(){for(var e=this.offset;e<=this.offset+this.capacity;e+=8)if(0!==this.values[this.getByteIndex(e)])for(var t=8*Math.floor(e/8),n=t;n<t+8;n++)if(this.get(n))return n;return 1/0}},{key:"max",value:function(){for(var e=this.capacity+this.offset;e>=this.offset;e-=8)if(0!==this.values[this.getByteIndex(e)])for(var t=8*Math.ceil(e/8)+1,n=t;n>t-8;n--)if(this.get(n))return n;return-1/0}}]),e}(),_=function(){function e(){Object(o.a)(this,e),this.lastVirtualFinish=0,this.nextVirtualFinish=1/0,this.queue=[]}return Object(c.a)(e,[{key:"computeWeight",value:function(){return 1}}]),e}(),z={Queue:function(){function e(t){Object(o.a)(this,e),this.rate=t,this.totalQueueSize=0,this.flows=[]}return Object(c.a)(e,[{key:"addFlow",value:function(e){return this.flows.push(e)}},{key:"removeFlow",value:function(e){var t=this.flows.indexOf(e);-1!==t&&this.flows.splice(t,1)}},{key:"enqueue",value:function(e,t,n){var a=e.computeWeight(this),i=this.rate/a,s=Math.max(Date.now(),e.lastVirtualFinish)+t/i;e.queue.push({virtualFinish:s,size:t,value:n}),e.lastVirtualFinish=s,1===e.queue.length&&(e.nextVirtualFinish=s)}},{key:"getNextScheduledFlow",value:function(){for(var e=1/0,t=null,n=0;n<this.flows.length;n++)this.flows[n].nextVirtualFinish<e&&(e=(t=this.flows[n]).nextVirtualFinish);return t}},{key:"peek",value:function(){var e=this.getNextScheduledFlow();return null===e?null:{flow:e,task:e.queue[0]}}},{key:"dequeue",value:function(){var e=this.getNextScheduledFlow();if(null===e)return null;var t=e.queue.shift();return e.nextVirtualFinish=0!==e.queue.length?e.queue[0].virtualFinish:1/0,{flow:e,task:t}}}]),e}(),Flow:_},V=function(){function e(t){Object(o.a)(this,e),this.values=new U(t)}return Object(c.a)(e,[{key:"setCapacity",value:function(e){this.values.resize(e)}},{key:"set",value:function(e,t){this.values.setRange(e.start/2,e.end/2+1,t)}},{key:"get",value:function(e){for(var t=e.start,n=e.end,a=void 0===n?t:n,i=t;i<=a;i+=2)if(!this.values.get(i/2))return!1;return!0}},{key:"min",value:function(){return 2*this.values.min()}},{key:"max",value:function(){return 2*this.values.max()}}]),e}(),K=function(e){function t(){return Object(o.a)(this,t),Object(h.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"advanceLastBin",value:function(e){Object(q.a)(Object(l.a)(t.prototype),"advanceLastIndex",this).call(this,e/2)}},{key:"setRange",value:function(e,n){for(var a=e.start,i=0;i<n.length;i++)Object(q.a)(Object(l.a)(t.prototype),"set",this).call(this,a/2+i,n[i])}},{key:"set",value:function(e,n){var a=e.bin;Object(q.a)(Object(l.a)(t.prototype),"set",this).call(this,a/2,n)}},{key:"get",value:function(e){var n=e.bin;return Object(q.a)(Object(l.a)(t.prototype),"get",this).call(this,n/2)}},{key:"forEach",value:function(e){for(var t=this.lastIndex-this.capacity;t<this.lastIndex&&!1!==e(this.get(t),2*t);t++);}}]),t}(g),W=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;Object(o.a)(this,e),this.firstSampleWindow=Math.floor(Date.now()/n),this.lastSampleWindow=this.firstSampleWindow,this.windowMs=t,this.sampleWindowMs=n,this.sum=0,this.values=new Array(Math.ceil(t/n)),this.values.fill(0)}return Object(c.a)(e,[{key:"adjustSampleWindow",value:function(){for(var e=Math.floor(Date.now()/this.sampleWindowMs),t=this.lastSampleWindow+1;t<=e;t++){var n=t%this.values.length;this.sum-=this.values[n],this.values[n]=0}this.lastSampleWindow=e}},{key:"update",value:function(e){this.adjustSampleWindow(),this.sum+=e,this.values[this.lastSampleWindow%this.values.length]+=e}},{key:"value",value:function(){this.adjustSampleWindow();var e=Math.min((this.lastSampleWindow-this.firstSampleWindow)*this.sampleWindowMs,this.windowMs);return this.sum/e}}]),e}(),F=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this,n))).lastEndBin=0,e}return Object(d.a)(t,e),Object(c.a)(t,[{key:"update",value:function(e){var n=e.start,a=e.end;0===this.lastHeadBin?Object(q.a)(Object(l.a)(t.prototype),"update",this).call(this,(a-n)/2):a>this.lastEndBin&&(Object(q.a)(Object(l.a)(t.prototype),"update",this).call(this,(a-this.lastEndBin)/2),this.lastEndBin=a)}}]),t}(W),Q=function(e){function t(e){var n;return Object(o.a)(this,t),(n=Object(h.a)(this,Object(l.a)(t).call(this))).id=e,n.queueSize=0,n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"computeWeight",value:function(e){return this.queueSize/e.totalQueueSize}}]),t}(z.Flow),G=function(e){function t(e){var n;return Object(o.a)(this,t),(n=Object(h.a)(this,Object(l.a)(t).call(this,e))).totalQueueSize=0,n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"enqueue",value:function(e,n,a){this.totalQueueSize+=n,e.queueSize+=n,Object(q.a)(Object(l.a)(t.prototype),"enqueue",this).call(this,e,n,a)}},{key:"cancel",value:function(e,t){var n=this;e.queue=e.queue.filter(function(a){var i=t(a.value);return i&&(n.totalQueueSize-=a.size,e.queueSize-=a.size),!i})}},{key:"dequeue",value:function(){var e=Object(q.a)(Object(l.a)(t.prototype),"dequeue",this).call(this);return null===e?null:(this.totalQueueSize-=e.task.size,e.flow.queueSize-=e.task.size,e)}}]),t}(z.Queue),Y=function(){function e(t){Object(o.a)(this,e),this.bin=t,this.reset()}return Object(c.a)(e,[{key:"reset",value:function(){this.availableCopies=0,this.requestTime=[0,0],this.requestPeerId=0,this.requested=!1,this.received=!1,this.verified=!1}}]),e}(),J=function(){function e(){Object(o.a)(this,e),this.valueByBin={},this.head=void 0,this.tail=void 0,this.length=0}return Object(c.a)(e,[{key:"insert",value:function(e){for(var t=Date.now(),n=e.start;n<=e.end;n+=2){var a={address:new v.a(n),createdAt:t,next:void 0,prev:void 0};this.valueByBin[n]=a,void 0===this.head?this.head=a:this.tail.next=a,a.prev=this.tail,this.tail=a,this.length++}}},{key:"get",value:function(e){var t=e.bin;return this.valueByBin[t]}},{key:"remove",value:function(e){var t=e.bin,n=this.valueByBin[t];void 0!==n&&(delete this.valueByBin[t],this.head===n&&(this.head=n.next),this.tail===n&&(this.tail=n.prev),void 0!==n.prev&&(n.prev.next=n.next),void 0!==n.next&&(n.next.prev=n.prev),this.length--)}},{key:"peek",value:function(){return this.head}},{key:"pop",value:function(){if(void 0!==this.head){var e=this.head;return this.head=e.next,this.tail===e&&(this.tail=e.prev),void 0!==e.next&&(e.next.prev=void 0),delete this.valueByBin[e.address.bin],this.length--,e}}}]),e}(),X=function(e){function t(){return Object(o.a)(this,t),Object(h.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"createEmptyValue",value:function(e,t){return void 0===t?new Y(e):(t.reset(),t)}}]),t}(K),Z=function e(t,n){Object(o.a)(this,e),this.peer=t,this.requestFlow=n,this.availableChunks=new V,this.ledbat=new A,this.rttMean=new b(.05),this.rttVar=new b(.05),this.chunkIntervalMean=new b(.25),this.chunkRate=new W(15e3),this.wasteRate=new W(15e3),this.lastChunkTime=null,this.requestTimes=new K,this.requestedChunks=new J,this.sentRequests=new J,this.timeouts=0,this.validChunks=0,this.invalidChunks=0,this.requestQueue=[],this.sentChunks=new V,this.receivedChunks=new V},$=function(){function e(t,n){Object(o.a)(this,e);var a=n.liveDiscardWindow,i=n.uploadRateLimit;this.chunkSize=t,this.liveDiscardWindow=a,this.peerStates={},this.chunkStates=new X(a),this.definitelyLoadedChunks=[],this.loadedChunks=new V(a),this.peerCount=0,this.chunkRate=new F,this.requestQueue=new G(i/1e3),this.timers={},this.lastExportedBin=-1/0,this.lastCompletedBin=-1/0,this.requestedChunks=new V(a),this.totalSends=0,this.totalRequests=0,this.totalRequestsReceived=0,this.totalReceived=0,this.totalAdded=0,this.totalCancelled=0,this.ackUnknownSend=0,this.totalDroppedRequests=0,this.sendDelay=new b(.05),this.nextSendTime=0,this.nextSendTimeout=0}return Object(c.a)(e,[{key:"debug",value:function(){var e=this;console.log("---"),Object.values(this.peerStates).forEach(function(t){if(t.peer.isReady()){var n=t.ledbat.cto/(t.ledbat.cwnd/e.chunkSize),a=Math.ceil(Math.min(n,1e3)),i=t.availableChunks,s=e.loadedChunks.min(),r=e.requestedChunks.min(),u=Math.max(i.min(),isFinite(s)?s:-1/0,isFinite(r)?s:-1/0,e.lastCompletedBin),o=Math.min(i.max(),u+2*e.liveDiscardWindow),c=Math.min(1e3,4*t.ledbat.rttMean.value()),h=t.chunkIntervalMean.value()||0,l=(0===h?1:Math.max(1,c/h))-t.sentRequests.length;console.log(JSON.stringify({peer_remoteId:t.peer.remoteId,peer_localId:t.peer.localId,sentRequests:t.sentRequests.length,swift_rtt:t.rttMean.value(),swift_rttvar:t.rttVar.value(),swift_chunkIntervalMean:t.chunkIntervalMean.value(),chunkRate:t.chunkRate.value(),wasteRate:t.wasteRate.value(),swift_cwnd:l,ledbat_cwnd:t.ledbat.cwnd,ledbat_cto:t.ledbat.cto,ledbat_currentDelay:t.ledbat.currentDelay.getMin(),ledbat_baseDelay:t.ledbat.baseDelay.getMin(),ledbat_rttMean:t.ledbat.rttMean.value(),ledbat_rttVar:t.ledbat.rttVar.value(),ledbat_rtt:t.ledbat.rtt,ledbat_flightSize:t.ledbat.flightSize,timeouts:t.timeouts,validChunks:t.validChunks,invalidChunks:t.invalidChunks,timeout:a,picker_startBin:u,picker_lastAvailableBin:o},!0,2))}}),console.log(JSON.stringify({totalSends:this.totalSends,totalRequests:this.totalRequests,totalRequestsReceived:this.totalRequestsReceived,totalDroppedRequests:this.totalDroppedRequests,totalReceived:this.totalReceived,totalAdded:this.totalAdded,totalCancelled:this.totalCancelled,ackUnknownSend:this.ackUnknownSend,minIncompleteBin:this.lastCompletedBin,sendDelay:this.sendDelay.value(),picker_firstLoadedChunk:this.loadedChunks.min(),picker_firstRequestedChunk:this.requestedChunks.min(),chunkRate:this.chunkRate.value()},!0,2))}},{key:"update",value:function(e,t){var n=this;if(e.peer.isReady()){var a=e.availableChunks,i=e.ledbat,s=e.sentRequests;i.digestDelaySamples();for(var r=Date.now(),u=Math.max(1e3,4*i.rttMean.value()),o=r-2*i.cto,c=e.chunkIntervalMean.value()||0,h=(0===c?1:Math.max(1,u/c))-s.length,l=[];void 0!==s.peek()&&s.peek().createdAt<o;)l.push(s.pop());l.length>0&&(this.totalCancelled+=l.length,l.forEach(function(e){var t=e.address;return s.remove(t)}));for(var d,f=Math.max(2*this.loadedChunks.values.offset+2,2*this.requestedChunks.values.offset+2,a.min(),this.lastCompletedBin),p=Math.min(f+2*this.liveDiscardWindow,a.max()),b=[],g=f;g<p&&b.length<h;g+=2){var m=new v.a(g);this.loadedChunks.get(m)||this.requestedChunks.get(m)||!a.get(m)||Math.random()<.05&&(b.push(m),s.insert(m),this.requestedChunks.set(m))}if(this.lastCompletedBin===-1/0&&0!==b.length){var k=b[0].bin;this.lastCompletedBin=k,this.lastExportedBin=k-2}if(0!==l.length&&l.forEach(function(t){var a=t.address;n.requestedChunks.set(a,!1),e.peer.sendCancel(a)}),0!==b.length)this.totalRequests+=b.length,(d=e.peer).sendRequest.apply(d,b),b.forEach(function(t){void 0===e.requestTimes.get(t)&&e.requestTimes.set(t,r)});for(;i.flightSize<i.cwnd&&e.requestQueue.length;){var y=e.requestQueue.shift();if(void 0!==y){var O=e.requestedChunks.get(y);void 0!==O&&(O.sentAt=r,e.ledbat.addSent(this.chunkSize),e.peer.sendChunk(y),this.totalSends++)}e.sentChunks.set(y)}e.peer.flush();var w=Math.min(1e3,(i.rttMean.value()||0)/(i.cwnd/this.chunkSize));this.timers[e.localId]=setTimeout(t,w)}else this.timers[e.localId]=setTimeout(t,1e3)}},{key:"addPeer",value:function(e){var t=this,n=e.localId,a=new Q(n);this.requestQueue.addFlow(a);var i=new Z(e,a);this.peerStates[n]=i;this.timers[n]=setTimeout(function e(){return t.update(i,e)},1e3)}},{key:"removePeer",value:function(e){var t=e.localId,n=this.peerStates[t];if(void 0!==n){var a=n.requestFlow;this.requestQueue.removeFlow(a),delete this.peerStates[t],clearTimeout(this.timers[t])}}},{key:"getPeerState",value:function(e){var t=e.localId;return this.peerStates[t]}},{key:"getRecentChunks",value:function(){var e=this.loadedChunks.max()-512;if(!isFinite(e))return[];for(var t=[],n=this.loadedChunks.max(),a=e;a<=n;a+=2){var i=new v.a(a);this.loadedChunks.get(i)&&t.push(i)}return t}},{key:"setLiveDiscardWindow",value:function(e,t){this.getPeerState(e).availableChunks.setCapacity(t),this.getPeerState(e).requestTimes.setCapacity(t),this.getPeerState(e).sentChunks.setCapacity(t),this.getPeerState(e).receivedChunks.setCapacity(t)}},{key:"markChunkReceived",value:function(e,t,n){var a=Date.now();this.totalReceived++;var i=this.getPeerState(e);if(void 0!==i&&(this.loadedChunks.get(t)&&i.wasteRate.update(1),void 0!==i.sentRequests.get(t))){if(null!==i.lastChunkTime){var s=a-i.lastChunkTime;i.chunkIntervalMean.update(s)}i.lastChunkTime=a,this.loadedChunks.get(t)||i.chunkRate.update(1);var r=i.requestTimes.get(t);void 0!==r&&i.ledbat.addRttSample(a-r),i.sentRequests.remove(t)}}},{key:"markChunkVerified",value:function(e,t){this.getPeerState(e).validChunks++,this.getPeerState(e).receivedChunks.set(t),this.definitelyLoadedChunks.push(t.bin),this.chunkRate.update(t),this.loadedChunks.set(t);for(var n=this.lastCompletedBin;this.loadedChunks.get(new v.a(n));n+=2)this.lastCompletedBin=n;Object.values(this.peerStates).forEach(function(e){var n=e.availableChunks,a=e.peer;!n.get(t)&&a.isReady()&&a.sendHave(t)})}},{key:"getNewCompleteBins",value:function(){var e=this.lastExportedBin+2;if(e<=this.lastCompletedBin)return this.lastExportedBin=this.lastCompletedBin,[e,this.lastCompletedBin]}},{key:"markChunkRejected",value:function(e,t){this.requestedChunks.set(t,!1),this.getPeerState(e).invalidChunks++}},{key:"markChunkAvailable",value:function(e,t){for(var n=t.start;n<=t.end;n+=2)this.getPeerState(e).availableChunks.get(new v.a(n))||this.totalAdded++;this.getPeerState(e).availableChunks.set(t)}},{key:"markChunksLoaded",value:function(e){this.chunkStates.advanceLastBin(e.end),this.loadedChunks.set(e),Object.values(this.peerStates).forEach(function(t){var n=t.availableChunks,a=t.peer;!n.get(e)&&a.isReady()&&a.sendHave(e)})}},{key:"markSendAcked",value:function(e,t,n){var a=this.getPeerState(e);a.ledbat.addDelaySample(n,this.chunkSize);var i=a.requestedChunks.get(t);void 0!==i?(i.sentAt&&a.ledbat.addRttSample(Date.now()-i.sentAt),a.requestedChunks.remove(t)):this.ackUnknownSend++}},{key:"enqueueRequest",value:function(e,t){for(var n=this.getPeerState(e),a=t.start;a<=t.end;a+=2)this.totalRequestsReceived++,n.requestQueue.push(new v.a(a));n.requestedChunks.insert(t)}},{key:"cancelRequest",value:function(e,t){var n=this.getPeerState(e),a=n.requestedChunks.get(t);a&&a.sentAt&&n.ledbat.onDataLoss(this.chunkSize),n.requestedChunks.remove(t)}}]),e}();n.d(t,"b",function(){return te}),n.d(t,"a",function(){return re});var ee=P(),te=function(e){function t(e,n){var a;Object(o.a)(this,t),a=Object(h.a)(this,Object(l.a)(t).call(this));var i=e.swarmId,s=e.protocolOptions,r=s[R.g.ContentIntegrityProtectionMethod],u=s[R.g.MerkleHashTreeFunction],c=s[R.g.LiveSignatureAlgorithm],d=s[R.g.ChunkAddressingMethod],f=s[R.g.ChunkSize],v=n.liveDiscardWindow,p=n.privateKey;a.uri=e,a.encoding=P(D(d,f),H(u),L(c,i));var b=void 0!==p?Object(M.c)(c,p):void 0;return a.contentIntegrity=Object(M.b)(r,Object(M.e)(u),Object(M.d)(c,i),b,v),a.chunkBuffer=new K(v),a.scheduler=new $(f,n),a.protocolOptions=[new a.encoding.VersionProtocolOption,new a.encoding.MinimumVersionProtocolOption,new a.encoding.SwarmIdentifierProtocolOption(i.toBuffer()),new a.encoding.ContentIntegrityProtectionMethodProtocolOption(r),new a.encoding.MerkleHashTreeFunctionProtocolOption(u),new a.encoding.LiveSignatureAlgorithmProtocolOption(c),new a.encoding.ChunkAddressingMethodProtocolOption(d),new a.encoding.ChunkSizeProtocolOption(f),new a.encoding.LiveDiscardWindowProtocolOption(v)],a}return Object(d.a)(t,e),Object(c.a)(t,[{key:"verifyProtocolOptions",value:function(e){Object.entries(this.uri.protocolOptions).forEach(function(t){var n=Object(u.a)(t,2),a=n[0],i=n[1];if(e[a]!==i){var s=R.g.name(a);throw new Error("invalid peer options: ".concat(s," mismatch"))}})}},{key:"emitNewData",value:function(){var e=this.scheduler.getNewCompleteBins();if(void 0!==e){for(var t=Object(u.a)(e,2),n=t[0],a=t[1],i=[],s=n;s<=a;s+=2)i.push(this.chunkBuffer.get(new v.a(s)));this.emit("data",i)}}}]),t}(f.EventEmitter),ne={CONNECTING:1,AWAITING_HANDSHAKE:2,READY:3,CHOKED:4,DISCONNECTING:5,CLOSED:6},ae=function(){function e(t){Object(o.a)(this,e),this.swarm=t,this.integrityVerifier=null}return Object(c.a)(e,[{key:"getContentIntegrityVerifier",value:function(e){return null===this.integrityVerifier&&(this.integrityVerifier=this.swarm.contentIntegrity.createVerifier(e)),this.integrityVerifier}}]),e}(),ie=function(){function e(t,n){var a,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.createChannelId();Object(o.a)(this,e),this.swarm=t,this.channel=n,this.remoteId=i,this.localId=s,this.state=ne.CONNECTING,this.handlers=(a={},Object(r.a)(a,R.f.HANDSHAKE,this.handleHandshakeMessage.bind(this)),Object(r.a)(a,R.f.DATA,this.handleDataMessage.bind(this)),Object(r.a)(a,R.f.HAVE,this.handleHaveMessage.bind(this)),Object(r.a)(a,R.f.ACK,this.handleAckMessage.bind(this)),Object(r.a)(a,R.f.INTEGRITY,this.handleIntegrityMessage.bind(this)),Object(r.a)(a,R.f.SIGNED_INTEGRITY,this.handleSignedIntegrityMessage.bind(this)),Object(r.a)(a,R.f.REQUEST,this.handleRequestMessage.bind(this)),Object(r.a)(a,R.f.CANCEL,this.handleCancelMessage.bind(this)),Object(r.a)(a,R.f.CHOKE,this.handleChokeMessage.bind(this)),Object(r.a)(a,R.f.UNCHOKE,this.handleUnchokeMessage.bind(this)),a),this.sendBuffer=[],this.swarm.scheduler.addPeer(this)}return Object(c.a)(e,[{key:"init",value:function(){this.sendHandshake(),this.flush(),this.state=ne.AWAITING_HANDSHAKE}},{key:"close",value:function(){this.state=ne.CLOSED,this.swarm.scheduler.removePeer(this)}},{key:"handleData",value:function(e){var t=this,n=new ae(this.swarm);e.messages.toArray().forEach(function(e){return t.handleMessage(e,n)})}},{key:"handleMessage",value:function(e,t){var n=this.handlers[e.type];if(void 0===n)throw new Error("unsupported message type");n(e,t)}},{key:"handleHandshakeMessage",value:function(e){var t=this,n=e.options.reduce(function(e,t){var n=t.type,a=t.value;return Object(s.a)({},e,Object(r.a)({},n,a))},{}),a=n[R.g.LiveDiscardWindow];void 0!==a&&this.swarm.scheduler.setLiveDiscardWindow(this,a),this.swarm.verifyProtocolOptions(n),this.remoteId=e.channelId,console.log("received handshake message while in state",this.state),this.state!==ne.READY&&(this.sendHandshake(),this.swarm.scheduler.getRecentChunks().forEach(function(e){return t.sendHave(e)}),this.flush()),this.state=ne.READY}},{key:"handleDataMessage",value:function(e,t){var n=this,a=v.a.from(e.address),i=A.computeOneWayDelay(e.timestamp.value);this.swarm.scheduler.markChunkReceived(this,a,i);var s=this.swarm.encoding;this.channel.send(new s.Datagram(this.remoteId,[new s.AckMessage(e.address,new s.Timestamp(i))])),t.getContentIntegrityVerifier(a).verifyChunk(a,e.data).then(function(){n.swarm.chunkBuffer.set(a,e.data),n.swarm.scheduler.markChunkVerified(n,a),n.swarm.emitNewData()}).catch(function(e){console.log("error validating chunk",e),n.swarm.scheduler.markChunkRejected(n,a)})}},{key:"handleHaveMessage",value:function(e){this.swarm.scheduler.markChunkAvailable(this,v.a.from(e.address))}},{key:"handleAckMessage",value:function(e){var t=v.a.from(e.address);this.swarm.scheduler.markChunkAvailable(this,t),this.swarm.scheduler.markSendAcked(this,t,e.delaySample.value)}},{key:"handleIntegrityMessage",value:function(e,t){var n=v.a.from(e.address);t.getContentIntegrityVerifier(n).setHash(n,e.hash.value)}},{key:"handleSignedIntegrityMessage",value:function(e,t){var n=v.a.from(e.address);t.getContentIntegrityVerifier(n).setHashSignature(n,e.signature.value)}},{key:"handleRequestMessage",value:function(e){this.swarm.scheduler.enqueueRequest(this,v.a.from(e.address))}},{key:"handleCancelMessage",value:function(e){this.swarm.scheduler.cancelRequest(this,v.a.from(e.address))}},{key:"handleChokeMessage",value:function(){this.state=ne.CHOKED}},{key:"handleUnchokeMessage",value:function(){this.state=ne.READY}},{key:"isReady",value:function(){return this.state===ne.READY}},{key:"sendHandshake",value:function(){var e=this.swarm.encoding;this.sendBuffer.push(new e.HandshakeMessage(this.localId,[].concat(Object(i.a)(this.swarm.protocolOptions),[new e.SupportedMessagesProtocolOption(Object.keys(this.handlers))])))}},{key:"sendHave",value:function(e){var t=this.swarm.encoding;this.sendBuffer.push(new t.HaveMessage(t.ChunkAddress.from(e)))}},{key:"sendRequest",value:function(){for(var e=this,t=this.swarm.encoding,n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];a.forEach(function(n){e.sendBuffer.push(new t.RequestMessage(t.ChunkAddress.from(n)))})}},{key:"sendCancel",value:function(){for(var e=this,t=this.swarm.encoding,n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];a.forEach(function(n){e.sendBuffer.push(new t.CancelMessage(t.ChunkAddress.from(n)))})}},{key:"sendChunk",value:function(e,t){var n=this,a=this.swarm.chunkBuffer.get(e);if(void 0!==a){var i=this.swarm.contentIntegrity.getConstituentSignatures(e);if(void 0!==i){var s=this.swarm.encoding;i.reverse().forEach(function(e,a){var i=e.bin,r=e.signature,u=s.ChunkAddress.from(new v.a(i));n.sendBuffer.push(new s.IntegrityMessage(u,new s.IntegrityHash(r.getHash()))),0===a&&n.sendBuffer.push(new s.SignedIntegrityMessage(u,new s.Timestamp(t),new s.LiveSignature(r.getSignatureHash())))}),this.sendBuffer.push(new s.DataMessage(s.ChunkAddress.from(e),a)),this.flush()}}}},{key:"flush",value:function(){if(0!==this.sendBuffer.length){var e=this.swarm.encoding;this.channel.send(new e.Datagram(this.remoteId,this.sendBuffer)),this.sendBuffer=[]}}}],[{key:"createChannelId",value:function(){return Math.round(Math.random()*R.d)}}]),e}(),se=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(h.a)(this,Object(l.a)(t).call(this))).setMaxListeners(1/0),e.swarms={},e}return Object(d.a)(t,e),Object(c.a)(t,[{key:"insert",value:function(e){var n=t.swarmIdToKey(e.uri.swarmId);void 0===this.swarms[n]&&(this.swarms[n]=e,this.emit("insert",e))}},{key:"remove",value:function(e){var n=t.swarmIdToKey(e.uri.swarmId);void 0!==this.swarms[n]&&(delete this.swarms[n],this.emit("remove",e))}},{key:"get",value:function(e){return this.swarms[t.swarmIdToKey(e)]}},{key:"toArray",value:function(){return Object.values(this.swarms)}}],[{key:"swarmIdToKey",value:function(e){return e.toBuffer().toString("base64")}}]),t}(f.EventEmitter),re=function(){function e(){Object(o.a)(this,e),this.channels=[],this.swarms=new se}return Object(c.a)(e,[{key:"publishSwarm",value:function(e){this.swarms.insert(e)}},{key:"unpublishSwarm",value:function(e){this.swarms.remove(e)}},{key:"joinSwarm",value:function(e){var t=e.protocolOptions[R.g.ChunkSize],n={liveDiscardWindow:Math.ceil(1e7/t),uploadRateLimit:1e6},a=new te(e,n);return this.swarms.insert(a),a}},{key:"createChannel",value:function(e){var t=this,n=new ue(e,this.swarms);this.channels.push(n),n.once("close",function(){var e=t.channels.indexOf(n);t.channels.splice(e,1)})}}]),e}(),ue=function(e){function t(e,n){var i;Object(o.a)(this,t),(i=Object(h.a)(this,Object(l.a)(t).call(this))).conn=e,i.swarms=n,i.peers={},i.handleSwarmInsert=i.getOrCreatePeer.bind(Object(a.a)(i)),i.swarms.on("insert",i.handleSwarmInsert);var s=n.toArray();return i.conn.addEventListener("open",function(){return s.forEach(i.handleSwarmInsert)}),i.conn.addEventListener("message",i.handleMessage.bind(Object(a.a)(i))),i.conn.addEventListener("error",function(e){return console.log("connection error:",e)}),i}return Object(d.a)(t,e),Object(c.a)(t,[{key:"handleMessage",value:function(e){var t=new ee.Datagram;t.read(e.data);var n=this.peers[t.channelId];if(void 0===n){if(0!==t.channelId)return;var a;try{a=t.messages.next()}catch(r){return void console.log("error decoding mesasge",r)}if(void 0===a||a.type!==R.f.HANDSHAKE)return void console.log("rejected new peer without handshake");var i=a.options.find(function(e){return e.type===R.g.SwarmIdentifier});if(void 0===i)return void console.log("rejecting new peer with invalid swarm id");var s=this.swarms.get(p.a.from(i.value));if(void 0===s)return void console.log("rejecting new peer requesting unknown swarm");n=this.getOrCreatePeer(s)}(t=new n.swarm.encoding.Datagram).read(e.data),n.handleData(t)}},{key:"send",value:function(e){try{this.conn.send(e.toBuffer())}catch(t){console.log("encountered error while sending",t),this.handleClose()}}},{key:"handleClose",value:function(){this.swarms.removeListener("insert",this.handleSwarmInsert),Object.values(this.peers).forEach(function(e){return e.close()}),this.emit("close")}},{key:"getOrCreatePeer",value:function(e){return Object.values(this.peers).find(function(t){return t.swarm===e})||this.createPeer(e)}},{key:"createPeer",value:function(e){var t=this.peers,n=this.swarms,a=new ie(e,this);return t[a.localId]=a,a.init(),n.on("remove",function i(s){s===e&&(delete t[a.localId],a.close(),n.removeListener("remove",i))}),a}}]),t}(f.EventEmitter)},56:function(e,t,n){"use strict";n.d(t,"a",function(){return j}),n.d(t,"b",function(){return S});var a=n(22),i=n(2),s=n(4),r=n(8),u=n(5),o=n(17),c=n(7),h=n(104),l=n.n(h),d=n(19),f=n(15),v=n.n(f),p=n(50),b=n.n(p),g=n(34),m=n.n(g),k=n(78),y=n.n(k),O=n(36),w=2,j=function(e){function t(e){var n;return Object(i.a)(this,t),(n=Object(r.a)(this,Object(u.a)(t).call(this))).setMaxListeners(1/0),n.id=e,n.channels=new l.a({numberOfNodesPerKBucket:w,localNodeId:n.id}),n.allChannels=new l.a({numberOfNodesPerKBucket:100,localNodeId:n.id}),n.channels.on("ping",n.handlePing.bind(Object(o.a)(n))),n.channels.on("removed",n.handleRemoved.bind(Object(o.a)(n))),n.channels.on("updated",n.handleUpdated.bind(Object(o.a)(n))),n.channels.on("added",n.handleAdded.bind(Object(o.a)(n))),n.knownPeerIds={},n.channelMap={},n.seenIds=new y.a({max:1024}),n.knownRoutes=new y.a({max:1024,maxAge:6e4}),n.callbacks=new y.a({max:1024}),n.on("receive.peers.request",n.handlePeersRequest.bind(Object(o.a)(n))),n.on("receive.ping.request",n.handlePingRequest.bind(Object(o.a)(n))),n.on("receive.trace.request",n.handleTraceRequest.bind(Object(o.a)(n))),n.on("receive.callback.response",n.handleCallbackResponse.bind(Object(o.a)(n))),n.startPeerRequests(),n}return Object(c.a)(t,e),Object(s.a)(t,[{key:"close",value:function(){var e=this;this.stopPeerRequests(),this.channels.toArray().forEach(function(t){var n=t.id;return e.removeChannel(n)}),this.emit("close")}},{key:"startPeerRequests",value:function(){var e=this,t=0,n=Object.keys(this.knownPeerIds);this.peerRequestIvl=setInterval(function(){var a=function(){for(var a=0;a<=n.length;a++){t>=n.length&&(t=0,n=Object.keys(e.knownPeerIds));var i=n[t];if(t++,i)return i}}();a&&e.sendPeerRequest(Object(O.a)(a))},5e3)}},{key:"stopPeerRequests",value:function(){clearInterval(this.peerRequestIvl)}},{key:"handlePing",value:function(e,t){var n=this,a=Date.now();e.forEach(function(e){var i=e.id,s=e.lastPing;if(a-s<3e4)n.addChannel(e);else{var r=function(){console.log("ping timeout removing",v()(i)),n.removeChannel(i),n.addChannel(t)};if(null!=e.conn){var u=setTimeout(r,1e3);n.sendPing(i,function(){clearTimeout(u),e.lastPing=a,n.addChannel(e)})}else setTimeout(function(){var e=n.getChannel(i);null==e||null==e.conn?r():n.addChannel(e)},1e3)}})}},{key:"addChannel",value:function(e){this.channels.add(e),this.allChannels.add(e)}},{key:"removeChannel",value:function(e){this.channels.remove(e),this.allChannels.remove(e),delete this.channelMap[v()(e)]}},{key:"getChannel",value:function(e){return this.channelMap[v()(e)]}},{key:"handleRemoved",value:function(e){console.log("remove",v()(e.id)),e.conn&&e.conn.close()}},{key:"handleUpdated",value:function(e,t){}},{key:"handleAdded",value:function(e){void 0===e.conn&&this.emit("peers.discover",e.id)}},{key:"createChannel",value:function(e,t){var n=this,a=new C(e,t);this.channelMap[v()(e)]=a;var i=[],s=function(e){return i.push(e)},r=this.handleMessage.bind(this,a),u=function(){n.addChannel(a),t.removeEventListener("message",s),t.addEventListener("message",r),i.forEach(r),n.sendPeerRequest(e),setTimeout(function(){return n.sendPeerRequest(e)},1e3)};t.addEventListener("message",s),t.addEventListener("open",u,{once:!0}),t.addEventListener("close",function e(){t.removeEventListener("message",s),t.removeEventListener("message",r),t.removeEventListener("open",u),t.removeEventListener("close",e),n.handleClose(a)},{once:!0})}},{key:"handleMessage",value:function(e,t){var n=this,i=JSON.parse(t.data),s=i.type,r=i.id;if(i.trace&&i.trace.push(v()(this.id)),!this.seenIds.get(r)){this.seenIds.set(r,!0),this.getChannel(e.id)||console.warn("receiving channel is not known to dht",v()(e.id)),this.knownRoutes.set(i.from,e.id);var u=Object(O.a)(i.to);if(b()(u,this.id)){this.emit("receive.".concat(s),{data:i,callback:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=Object(O.a)(i.from),u=Object(a.a)({re:r},e);n.send(s,"callback.response",u,t)}})}else this.forwardMessage(u,i)}}},{key:"forwardMessage",value:function(e,t){t.hops>=10||(t.hops++,this.sendRaw(e,JSON.stringify(t),t.trace))}},{key:"handleClose",value:function(e){var t=e.id;console.warn("handleClose",v()(t)),this.removeChannel(t),delete this.channelMap[v()(t)]}},{key:"sendPing",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};this.send(e,"ping.request",{},t)}},{key:"handlePingRequest",value:function(e){e.data;(0,e.callback)({})}},{key:"handleTraceRequest",value:function(e){var t=e.data;(0,e.callback)(t)}},{key:"handleCallbackResponse",value:function(e){var t=e.data,n=e.callback,a=this.callbacks.get(t.re);a&&a(t,n)}},{key:"sendPeerRequest",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,a=setTimeout(function(){delete t.knownPeerIds[v()(e)]},5e3);this.send(e,"peers.request",{count:n},function(e){clearTimeout(a),t.handlePeersResponse(e)})}},{key:"handlePeersRequest",value:function(e){var t=e.data,n=(t.count,t.from);(0,e.callback)({ids:this.allChannels.closest(Object(O.a)(n)).filter(function(e){return null!=e.conn}).map(function(e){var t=e.id;return v()(t)})})}},{key:"handlePeersResponse",value:function(e){var t=this;e.ids.map(function(e){return Object(O.a)(e)}).filter(function(e){return!b()(e,t.id)}).filter(function(e){var n=t.getChannel(e);return null==n||null==n.conn}).forEach(function(e){t.knownPeerIds[v()(e)]=!0,t.addChannel(new C(e))})}},{key:"send",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;"function"===typeof n&&(i=n,n={});var s=v()(m()(16));this.seenIds.set(s,!0),null!=i&&this.callbacks.set(s,i);var r=JSON.stringify(Object(a.a)({id:s,type:t,from:v()(this.id),to:v()(e),trace:[v()(this.id)],hops:0},n));this.sendRaw(e,r)}},{key:"sendRaw",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=this.allChannels.closest(e).filter(function(e){return null!=e.conn}).filter(function(e){var t=e.idHex;return-1===n.indexOf(t)}).slice(0,2),i=this.knownRoutes.get(v()(e));if(i){var s=this.getChannel(i);null!=s&&null!=s.conn&&a.push(s)}0!==a.length&&(b()(a[0].id,e)&&(a=a.slice(0,1)),a.forEach(function(e){return e.conn.send(t)}))}}]),t}(d.EventEmitter),C=function e(t,n){Object(i.a)(this,e),this.id=t,this.idHex=v()(t),this.vectorClock=Date.now(),this.lastPing=Date.now(),this.conn=n},S=function(){function e(t,n){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:v()(m()(16));Object(i.a)(this,e),this.client=t,this.peerId=n,this.id=a,this.readyState=e.ReadyStates.OPEN,this.onmessage=function(){},this.handleMessage=this.handleMessage.bind(this),this.client.on("receive.subchannel.message",this.handleMessage)}return Object(s.a)(e,[{key:"handleMessage",value:function(e){var t=e.data,n=t.channelId,a=t.data;n===this.id&&this.onmessage({data:a})}},{key:"send",value:function(e){this.client.send(this.peerId,"subchannel.message",{channelId:this.id,data:e})}},{key:"close",value:function(){this.readyState=e.ReadyStates.CLOSED,this.client.removeListener("receive.subchannel.message",this.handleMessage)}}]),e}();S.ReadyStates={OPEN:1,CLOSED:3}},57:function(e,t,n){"use strict";(function(e){n.d(t,"b",function(){return b}),n.d(t,"a",function(){return m});var a=n(14),i=n(8),s=n(5),r=n(17),u=n(7),o=n(4),c=n(2),h=n(55),l=n(56),d=n(19),f=n(15),v=n.n(f),p=n(105),b=function e(){Object(c.a)(this,e),this.dhtClient=new l.a(Object(p.a)()),this.ppsppClient=new h.a},g=[],m=function(){function e(t){Object(c.a)(this,e),this.server=t}return Object(o.a)(e,[{key:"bootstrap",value:function(){var e=this,t=Object(p.a)(),n={type:"bootstrap",bootstrapId:v()(this.server.dhtClient.id),id:v()(t)},a=new k,i=this.createClient(a);return i.on("datachannel",function(n){var a=n.channel;"dht"===a.label?e.server.dhtClient.createChannel(t,a):"ppspp"===a.label&&e.server.ppsppClient.createChannel(a)}),g.push(i),g.length>11&&g.shift().close(),Promise.resolve({data:n,conn:a.remote})}},{key:"createClient",value:function(e){var t=new y(e),n=new O(t);return t.on("connection",function(){return e.close()}),n}}]),e}(),k=function(t){function n(e){var t;return Object(c.a)(this,n),(t=Object(i.a)(this,Object(s.a)(n).call(this))).remote=e||new n(Object(r.a)(t)),t.remote.remote=Object(r.a)(t),t.onmessage=function(){},t.closed=!1,t}return Object(u.a)(n,t),Object(o.a)(n,[{key:"send",value:function(t){var n=this;this.closed||e(function(){n.remote.emit("message",{data:t}),n.remote.onmessage({data:t})})}},{key:"addEventListener",value:function(){this.on.apply(this,arguments)}},{key:"removeEventListener",value:function(){this.removeListener.apply(this,arguments)}},{key:"close",value:function(){this.closed=!0,this.remote.emit("close"),this.emit("close")}}]),n}(d.EventEmitter),y=function(e){function t(e){var n;return Object(c.a)(this,t),(n=Object(i.a)(this,Object(s.a)(t).call(this))).conn=e,n.conn.onmessage=n.handleMessage.bind(Object(r.a)(n)),n}return Object(u.a)(t,e),Object(o.a)(t,[{key:"handleMessage",value:function(e){var t=JSON.parse(e.data);switch(t.type){case"connection":this.handleConnection(t);break;default:this.emit("error",new Error("unsupported mediator event type"))}}},{key:"handleConnection",value:function(e){var n=this,i=e.id,s=t.datachannels[i];delete t.datachannels[i],Object.entries(s).forEach(function(e){var t=Object(a.a)(e,2),i=t[0],s=t[1];return n.emit("datachannel",i,s)}),this.emit("open")}},{key:"sendConnection",value:function(e){var n=t.nextId++;t.datachannels[n]=e,this.conn.send(JSON.stringify({type:"connection",id:n})),this.emit("open")}}]),t}(d.EventEmitter);y.nextId=0,y.datachannels={};var O=function(t){function n(e){var t;return Object(c.a)(this,n),(t=Object(i.a)(this,Object(s.a)(n).call(this))).mediator=e,t.datachannels={},t.conns=[],e.on("datachannel",t.handleDataChannel.bind(Object(r.a)(t))),e.once("open",t.handleOpen.bind(Object(r.a)(t))),t}return Object(u.a)(n,t),Object(o.a)(n,[{key:"handleDataChannel",value:function(e,t){var n=new w(this,e,t);this.conns.push(n),this.emit("datachannel",{label:e,channel:n})}},{key:"handleOpen",value:function(){var t=this;e(function(){return t.emit("open")})}},{key:"createDataChannel",value:function(e){var t=new w(this,e);return this.datachannels[e]=t,this.conns.push(t),t}},{key:"init",value:function(){this.mediator.sendConnection(this.datachannels)}},{key:"close",value:function(){this.conns.forEach(function(e){return e.close()}),this.emit("close")}}]),n}(d.EventEmitter),w=function(e){function t(e,n,a){var r;return Object(c.a)(this,t),(r=Object(i.a)(this,Object(s.a)(t).call(this,a))).client=e,r.label=n,r.open=!1,r.client.on("open",function(){r.emit("open"),r.open=!0}),r}return Object(u.a)(t,e),t}(k)}).call(this,n(118).setImmediate)},67:function(e,t,n){"use strict";(function(e){n.d(t,"c",function(){return v}),n.d(t,"a",function(){return b}),n.d(t,"b",function(){return g});var a=n(17),i=n(2),s=n(4),r=n(8),u=n(5),o=n(7),c=n(19),h=n(158),l=e.from("4c93bf00ae13c37e5df3b7a9cea0413521fe1b08a627d065d7180b9d0738c666","hex"),d=l.length,f=function(t){function n(e){var t;return Object(i.a)(this,n),(t=Object(r.a)(this,Object(u.a)(n).call(this))).injector=e,t}return Object(o.a)(n,t),Object(s.a)(n,[{key:"write",value:function(t){var n=e.alloc(4);n.writeUInt32BE(t.length),this.injector.appendData(e.concat([l,e.from([0]),n,l,e.from([1]),n],74)),this.injector.appendData(t)}}]),n}(c.EventEmitter),v=function(t){function n(){return Object(i.a)(this,n),Object(r.a)(this,Object(u.a)(n).apply(this,arguments))}return Object(o.a)(n,t),Object(s.a)(n,[{key:"start",value:function(){var t=this,n=e.alloc(437500);n.fill(255),h.a.create().then(function(e){t.injector=e;var a=new f(e);t.intervalId=setInterval(function(){return a.write(n)},1e3),t.emit("publish",e)})}},{key:"stop",value:function(e){clearInterval(this.intervalId),this.emit("unpublish",this.injector),e&&setTimeout(e)}}]),n}(c.EventEmitter),p=function(e){function t(e){var n;return Object(i.a)(this,t),(n=Object(r.a)(this,Object(u.a)(t).call(this))).swarm=e,n.handleWarmupSwarmData=n.handleWarmupSwarmData.bind(Object(a.a)(n)),n.handleSwarmData=n.handleSwarmData.bind(Object(a.a)(n)),n.chunkBufferLength=0,n.nextDataOffset=0,n.nextDataLength=0,n.swarm.on("data",n.handleWarmupSwarmData),n}return Object(o.a)(t,e),Object(s.a)(t,[{key:"handleWarmupSwarmData",value:function(e){for(var t=0;t<e.length;t++){var n=e[t].indexOf(l);if(!(-1===n||n+37>e[t].length)){this.swarm.removeListener("data",this.handleWarmupSwarmData),this.swarm.on("data",this.handleSwarmData),this.readHeader(e[t],n),this.handleSwarmData(e.slice(t));break}}}},{key:"readHeader",value:function(e,t){var n=e.readUInt8(t+d);this.nextDataOffset=t+37*(2-n),this.nextDataLength=e.readUInt32BE(t+d+1)}},{key:"handleSwarmData",value:function(e){for(var t=0;t<e.length;t++){var n=this.chunkBufferLength;this.chunkBufferLength+=e[t].length;var a=this.nextDataOffset+this.nextDataLength;if(this.chunkBufferLength<a)this.handleData(e[t],n);else{var i=a-n;if(this.handleEndData(e[t],i),this.chunkBufferLength-a<=37)return this.swarm.removeListener("data",this.handleSwarmData),this.swarm.on("data",this.handleWarmupSwarmData),this.chunkBufferLength=0,void this.handleWarmupSwarmData(e.slice(t));this.chunkBufferLength=0,this.readHeader(e[t],i),t--}}}}]),t}(c.EventEmitter),b=function(e){function t(e){var n;return Object(i.a)(this,t),(n=Object(r.a)(this,Object(u.a)(t).call(this,e))).firstEmitted=!1,n}return Object(o.a)(t,e),Object(s.a)(t,[{key:"handleData",value:function(e,t){this.firstEmitted?this.emit("data",e):this.chunkBufferLength>this.nextDataOffset&&(this.emit("start",e.slice(this.nextDataOffset-t)),this.firstEmitted=!0)}},{key:"handleEndData",value:function(e,t){this.emit("end",e.slice(0,t)),this.firstEmitted=!1}}]),t}(p),g=function(e){function t(e){var n;return Object(i.a)(this,t),(n=Object(r.a)(this,Object(u.a)(t).call(this,e))).chunkBuffer=[],n}return Object(o.a)(t,e),Object(s.a)(t,[{key:"handleData",value:function(e){this.chunkBuffer.push(e)}},{key:"handleEndData",value:function(e,t){this.chunkBuffer.push(e);var n=this.chunkBuffer.slice();n[n.length-1]=n[n.length-1].slice(0,t);var a=this.nextDataOffset;a>n[0].length&&(a-=n[0].length,n.shift()),n[0]=n[0].slice(a),this.emit("data",{chunks:n,length:this.nextDataLength}),this.chunkBuffer=[]}}]),t}(p)}).call(this,n(9).Buffer)},74:function(e,t,n){"use strict";n.d(t,"a",function(){return v});var a,i=n(22),s=n(14),r=n(2),u=n(4),o=n(6),c=n(102),h=n.n(c),l=n(53),d=n(1),f=(a={},Object(o.a)(a,d.g.ContentIntegrityProtectionMethod,"x.im"),Object(o.a)(a,d.g.MerkleHashTreeFunction,"x.hf"),Object(o.a)(a,d.g.LiveSignatureAlgorithm,"x.sa"),Object(o.a)(a,d.g.ChunkAddressingMethod,"x.am"),Object(o.a)(a,d.g.ChunkSize,"x.cs"),a),v=function(){function e(t,n){Object(r.a)(this,e),this.swarmId=t,this.protocolOptions=n}return Object(u.a)(e,[{key:"toString",value:function(){var e=h.a.encode(this.swarmId.toBuffer()),t=Object.entries(this.protocolOptions).map(function(e){var t=Object(s.a)(e,2),n=t[0],a=t[1];return"".concat(f[n],"=").concat(a)}).join("&");return"magnet:?xt=urn:ppspp:".concat(e,"&").concat(t)}}],[{key:"parse",value:function(t){if(!t.startsWith("magnet:"))throw new Error("invalid uri: expected magnet");var n=t.substring(8).split("&").map(function(e){var t=e.split("="),n=Object(s.a)(t,2),a=n[0],i=n[1];return[a,decodeURIComponent(i)]}),a=Object.entries(f).reduce(function(e,t){var a=Object(s.a)(t,2),r=a[0],u=a[1],c=n.find(function(e){return Object(s.a)(e,1)[0]===u});if(void 0===c)throw new Error("invalid uri: missing ".concat(u));return Object(i.a)({},e,Object(o.a)({},r,parseFloat(c[1])))},{}),r=n.find(function(e){var t=Object(s.a)(e,2),n=t[0],a=t[1];return"xt"===n&&a.startsWith("urn:ppspp:")});if(void 0===r)throw new Error("invalid uri: missing suitable xt");return new e(l.a.from(h.a.decode(r[1].substring(10))),a)}}]),e}()}},[[170,1,2]]]);
//# sourceMappingURL=main.ea15d732.chunk.js.map