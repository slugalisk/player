((self||this).webpackJsonp=(self||this).webpackJsonp||[]).push([[6],{5746:function(e,t,n){"use strict";(function(e){n.d(t,"b",function(){return O}),n.d(t,"a",function(){return b});var a=n(4),i=n(9),r=n(6),o=n(19),c=n(8),s=n(3),l=n(2),u=n(89),d=n(90),h=n(21),f=n(25),v=n.n(f),p=n(5747),O=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object(l.a)(this,e),this.queue=[],this.dhtClient=t.dhtClient||new d.a(Object(p.a)()),this.ppsppClient=t.ppsppClient||new u.a},b=function(){function e(t){Object(l.a)(this,e),this.server=t}return Object(s.a)(e,[{key:"bootstrap",value:function(){var e=this,t=Object(p.a)(),n={type:"bootstrap",bootstrapId:v()(this.server.dhtClient.id),id:v()(t)},a=m.open(),i=this.createClient(a);return i.on("datachannel",function(n){var a=n.channel;"dht"===a.label?e.server.dhtClient.createChannel(t,a):"ppspp"===a.label&&e.server.ppsppClient.createChannel(a)}),this.server.queue.push(i),this.server.queue.length>6&&this.server.queue.shift().close(),Promise.resolve({data:n,conn:a.remote})}},{key:"createClient",value:function(e){var t=new y(e),n=new C(t);return t.on("connection",function(){return e.close()}),n}}]),e}(),m=function(t){function n(e){var t;return Object(l.a)(this,n),(t=Object(i.a)(this,Object(r.a)(n).call(this))).remote=e||new n(Object(o.a)(t)),t.remote.remote=Object(o.a)(t),t.readyState=t.remote.readyState||n.ReadyStates.CONNECTING,t.onmessage=function(){},t}return Object(c.a)(n,t),Object(s.a)(n,[{key:"send",value:function(t){var a=this;this.readyState===n.ReadyStates.OPEN&&e(function(){a.remote.emit("message",{data:t}),a.remote.onmessage({data:t})})}},{key:"addEventListener",value:function(){this.on.apply(this,arguments)}},{key:"removeEventListener",value:function(){this.removeListener.apply(this,arguments)}},{key:"open",value:function(){this.readyState=n.ReadyStates.OPEN,this.remote.readyState=n.ReadyStates.OPEN,this.emit("open")}},{key:"close",value:function(){this.readyState=n.ReadyStates.CLOSING,this.remote.readyState=n.ReadyStates.CLOSING,this.remote.emit("close"),this.emit("close"),this.readyState=n.ReadyStates.CLOSED,this.remote.readyState=n.ReadyStates.CLOSED,this.removeAllListeners(),this.remote.removeAllListeners()}}],[{key:"open",value:function(){var e=new n;return e.open(),e.remote.open(),e}}]),n}(h.EventEmitter);m.ReadyStates={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed"};var y=function(e){function t(e){var n;return Object(l.a)(this,t),(n=Object(i.a)(this,Object(r.a)(t).call(this))).conn=e,n.conn.onmessage=n.handleMessage.bind(Object(o.a)(n)),n}return Object(c.a)(t,e),Object(s.a)(t,[{key:"handleMessage",value:function(e){var t=JSON.parse(e.data);switch(t.type){case"connection":this.handleConnection(t);break;default:this.emit("error",new Error("unsupported mediator event type"))}}},{key:"handleConnection",value:function(e){var n=this,i=e.id,r=t.datachannels[i];delete t.datachannels[i],Object.entries(r).forEach(function(e){var t=Object(a.a)(e,2),i=t[0],r=t[1];return n.emit("datachannel",i,r)}),this.emit("open")}},{key:"sendConnection",value:function(e){var n=t.nextId++;t.datachannels[n]=e,this.conn.send(JSON.stringify({type:"connection",id:n})),this.emit("open")}}]),t}(h.EventEmitter);y.nextId=0,y.datachannels={};var C=function(t){function n(e){var t;return Object(l.a)(this,n),(t=Object(i.a)(this,Object(r.a)(n).call(this))).mediator=e,t.datachannels={},t.conns=[],e.on("datachannel",t.handleDataChannel.bind(Object(o.a)(t))),e.once("open",t.handleOpen.bind(Object(o.a)(t))),t}return Object(c.a)(n,t),Object(s.a)(n,[{key:"handleDataChannel",value:function(e,t){var n=new j(this,e,t);this.conns.push(n),this.emit("datachannel",{label:e,channel:n})}},{key:"handleOpen",value:function(){var t=this;e(function(){t.conns.forEach(function(e){return e.open()}),t.emit("open")})}},{key:"createDataChannel",value:function(e){var t=new j(this,e);return this.datachannels[e]=t,this.conns.push(t),t}},{key:"init",value:function(){this.mediator.sendConnection(this.datachannels)}},{key:"close",value:function(){this.closed||(this.closed=!0,this.conns.forEach(function(e){return e.close()}),this.emit("close"),this.removeAllListeners())}}]),n}(h.EventEmitter),j=function(e){function t(e,n,a){var o;return Object(l.a)(this,t),(o=Object(i.a)(this,Object(r.a)(t).call(this,a))).client=e,o.label=n,o}return Object(c.a)(t,e),t}(m)}).call(this,n(76).setImmediate)},5747:function(e,t,n){"use strict";var a=n(101),i=n.n(a);t.a=function(){var e=new Uint8Array(16);return i.a.randomFillSync(e),e}},5832:function(e,t,n){"use strict";n.r(t);var a=n(4),i=n(27),r=n(49),o=n(220),c=n(0),s=n.n(c),l=n(5746),u=n(133),d=n(25),h=n.n(d),f=n(5830),v=n(5762),p=n(219),O=(n(240),Object(p.b)(v.a)),b=function(e,t){var n=t.type,a=Object(o.a)(t,["type"]);switch(n){case"ADD_NODE":return{nodes:[].concat(Object(r.a)(e.nodes),[a]),links:e.links};case"REMOVE_NODE":return{nodes:e.nodes.filter(function(e){return e.id!==a.id}),links:e.links.filter(function(e){var t=e.source,n=e.target;return t.id!==a.id&&n.id!==a.id})};case"ADD_LINK":return{nodes:e.nodes,links:[].concat(Object(r.a)(e.links),[Object(i.a)({},a,{activity:0})])};case"UPDATE_LINK":return{nodes:e.nodes,links:e.links.map(function(e){var t=e.source,n=e.target;return t.id!==a.source||n.id!==a.target?e:Object(i.a)({},e,a)})};case"INCR_LINK_ACTIVITY":return{nodes:e.nodes,links:e.links.map(function(e){var t=e.source,n=e.target;return t.id!==a.source||n.id!==a.target?e:Object(i.a)({},e,{activity:e.activity+1})})};case"DECR_LINK_ACTIVITY":return{nodes:e.nodes,links:e.links.map(function(e){var t=e.source,n=e.target;return t.id!==a.source||n.id!==a.target?e:Object(i.a)({},e,{activity:e.activity-1})})};case"REMOVE_LINK":return{nodes:e.nodes,links:e.links.filter(function(e){var t=e.source,n=e.target;return t.id!==a.source||n.id!==a.target})};default:return e}};t.default=function(){var e=function(){var e=Object(c.useState)([new l.b]),t=Object(a.a)(e,2),n=t[0],o=t[1],s=Object(c.useState)(1),d=Object(a.a)(s,2),f=d[0],v=d[1],p=Object(c.useReducer)(b,{nodes:[],links:[]}),m=Object(a.a)(p,2),y=m[0],C=m[1];Object(c.useEffect)(function(){var e=h()(n[0].dhtClient.id);C({type:"ADD_NODE",id:e,color:"#fff",dhtClient:n[0].dhtClient}),j(3).then(function(e){return e.map(function(e){var t=e.dhtClient,n=e.ppsppClient;return new l.b({dhtClient:t,ppsppClient:n})})}).then(function(e){return o([].concat(Object(r.a)(n),Object(r.a)(e)))})},[]);var j=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};v(f+1);var a=Promise.all(new Array(e).fill(0).map(function(){var e=n.length-1,t=Math.min(e,1+Math.floor(Math.random()*e)),a=n[t];return u.a.create(new l.a(a))}));return a.then(function(e){return e.forEach(function(e){var n=e.dhtClient,a=n.id,r=n.allChannels,o=h()(a);C(Object(i.a)({type:"ADD_NODE",id:o,color:O(f),dhtClient:n},t)),n.on("close",function(){return C({type:"REMOVE_NODE",id:o})}),r.toArray().forEach(function(e){e.isOpen()&&C({type:"ADD_LINK",source:o,target:h()(e.id),color:e.isOpen()?"#fff":"#66f"})}),r.on("added",function(e){if(e.isOpen()){var t=h()(e.id);C({type:"ADD_LINK",source:o,target:t,color:e.isOpen()?"#fff":"#66f"})}}),r.on("updated",function(e,t){if(e.isOpen()!==t.isOpen()){var n=h()(t.id);C({type:"ADD_LINK",source:o,target:n,color:t.isOpen()?"#fff":"#66f"})}}),r.on("removed",function(e){var t=e.id;return C({type:"REMOVE_LINK",source:o,target:h()(t)})})})}),a};return[y,{addNodes:j,deleteNodes:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0;t<e;t++){var a=n.length,i=y.nodes[a+Math.floor(Math.random()*(Object.keys(y.nodes).length-a))];i&&i.dhtClient.close()}}}]}(),t=Object(a.a)(e,2),n=t[0],o=t[1],d=o.addNodes,v=o.deleteNodes,p=function(){var e=Object(c.useState)(null),t=Object(a.a)(e,2),n=t[0],i=t[1];return function(e){if(console.log(e),null===n)return i(e),void console.log("set source",h()(e.dhtClient.id));console.log("pinging %s > %s",h()(n.dhtClient.id),h()(e.dhtClient.id)),n.dhtClient.sendPing(e.dhtClient.id,function(e){console.log("received ping response",e)}),i(null)}}();return s.a.createElement("div",null,s.a.createElement("div",{className:"graph-buttons"},s.a.createElement("button",{onClick:function(){return d(1)}},"add 1 peer"),s.a.createElement("button",{onClick:function(){return d(5)}},"add 5 peers"),s.a.createElement("button",{onClick:function(){return v(1)}},"delete 1 peer"),s.a.createElement("button",{onClick:function(){return v(5)}},"delete 5 peers")),s.a.createElement(f.a,{graphData:n,nodeAutoColorBy:"gen",onNodeClick:p,linkColor:function(e){return e.color},linkWidth:1.5,nodeRelSize:2,nodeVal:function(e){return e.dhtClient.allChannels.count()}}))}}}]);
//# sourceMappingURL=6.bf3dd64a.chunk.js.map