import React, {useEffect, useState, useMemo, useRef} from 'react';
import URI from '../ppspp/uri';
import DiagnosticMenu from './DiagnosticMenu';
import SwarmPlayer from './SwarmPlayer';
import {ChunkedReadStream} from '../chunkedStream';
import {Client} from '../client';
import {ConnManager} from '../wrtc';
import {PubSubConsumer} from '../pubsub';
import PlayButton from './PlayButton';
import qs from 'qs';
import {useTimeout, useAsync} from 'react-use';
import hexToUint8Array from '../hexToUint8Array';
import moment from 'moment';

const usePubSubSwarm = (client, name) => {
  const [swarm, setSwarm] = useState(null);
  const [consumer, setConsumer] = useState(null);

  useEffect(() => {
    if (client) {
      setImmediate(() => {
        const {uri} = client.bootstrap.swarms.find(desc => desc.name === name);
        const swarm = client.ppsppClient.joinSwarm(URI.parse(uri));
        const consumer = new PubSubConsumer(swarm);

        setSwarm(swarm);
        setConsumer(consumer);

        return () => client.ppsppClient.leaveSwarm(URI.parse(uri));
      });
    }
  }, [client]);

  return [consumer, swarm];
};

const useIndexSwarm = client => usePubSubSwarm(client, 'index');
